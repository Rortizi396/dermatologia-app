<div class="container-xxl py-3">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2 mb-3">
    <h4 class="mb-0">Administración de Pacientes</h4>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <div class="input-group" style="min-width:280px">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" class="form-control" [(ngModel)]="search" (ngModelChange)="applyFilters()" placeholder="Buscar por nombre, DPI, correo o teléfono" />
      </div>
      <div class="d-flex align-items-center gap-2">
        <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()" style="width:160px">
          <option value="todos">Todos</option>
          <option value="activos">Activos</option>
          <option value="inactivos">Inactivos</option>
        </select>
        <select class="form-select" [(ngModel)]="sortBy" (change)="applyFilters()" style="width:170px">
          <option value="apellidos">Ordenar por Apellidos</option>
          <option value="nombres">Ordenar por Nombres</option>
          <option value="dpi">Ordenar por DPI</option>
          <option value="correo">Ordenar por Correo</option>
        </select>
        <select class="form-select" [(ngModel)]="sortDir" (change)="applyFilters()" style="width:120px">
          <option value="asc">Ascendente</option>
          <option value="desc">Descendente</option>
        </select>
        <select class="form-select" [(ngModel)]="pageSize" (change)="changePageSize()" style="width:120px">
          <option *ngFor="let o of pageSizeOptions" [value]="o">{{ o }} / pág</option>
        </select>
      </div>
    </div>
  </div>

  <div class="mb-2 d-flex flex-wrap gap-2">
    <span class="badge rounded-pill bg-primary-subtle text-primary">Total: {{ totalCount }}</span>
    <span class="badge rounded-pill bg-success-subtle text-success">Activos: {{ activeCount }}</span>
    <span class="badge rounded-pill bg-secondary-subtle text-secondary">Inactivos: {{ inactiveCount }}</span>
  </div>

  <div class="table-responsive shadow-sm rounded bg-white">
    <table class="table table-striped table-hover table-bordered align-middle mb-0 w-100">
      <thead class="table-light position-sticky top-0" style="z-index:1">
        <tr>
          <th (click)="setSort('dpi')" class="sortable" [class.sorted-col]="isSortedField('dpi')">DPI <span class="arrow">{{ sortArrow('dpi') }}</span></th>
          <th (click)="setSort('apellidos')" class="sortable" [class.sorted-col]="isSortedField('apellidos') || isSortedField('nombres')">Nombre <span class="arrow">{{ sortArrow('apellidos') }}</span></th>
          <th class="d-none d-sm-table-cell">Teléfono</th>
          <th (click)="setSort('correo')" class="sortable" [class.sorted-col]="isSortedField('correo')">Correo <span class="arrow">{{ sortArrow('correo') }}</span></th>
          <th class="d-none d-md-table-cell">Estado</th>
          <th style="width:160px">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Skeleton rows while loading -->
        <ng-container *ngIf="loading">
          <tr *ngFor="let _ of skeletonRows">
            <td class="text-nowrap"><div class="sk sk-text w-75"></div></td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="sk sk-avatar"></div>
                <div class="flex-grow-1">
                  <div class="sk sk-text w-50 mb-1"></div>
                  <div class="sk sk-text w-25"></div>
                </div>
              </div>
            </td>
            <td class="d-none d-sm-table-cell"><div class="sk sk-text w-50"></div></td>
            <td><div class="sk sk-text w-75"></div></td>
            <td class="d-none d-md-table-cell"><div class="sk sk-badge w-50"></div></td>
            <td>
              <div class="d-flex gap-2">
                <div class="sk sk-btn"></div>
                <div class="sk sk-btn"></div>
              </div>
            </td>
          </tr>
        </ng-container>

        <!-- Real rows when not loading -->
        <tr *ngFor="let p of paged" [class.d-none]="loading">
          <td class="text-nowrap" [class.sorted-col]="isSortedField('dpi')">{{ p.DPI }}</td>
          <td [class.sorted-col]="isSortedField('apellidos') || isSortedField('nombres')">
            <div class="fw-semibold d-flex align-items-center gap-2">
              <div class="avatar text-white d-inline-flex align-items-center justify-content-center" [ngStyle]="avatarStyle(p)">
                {{ initials(p) }}
              </div>
              <span>{{ p.Nombres }} {{ p.Apellidos }}</span>
            </div>
            <small class="text-muted d-sm-none">Tel: {{ p.Telefono || '—' }}</small>
            <div class="small text-muted">DPI: {{ p.DPI }}</div>
          </td>
          <td class="d-none d-sm-table-cell" *ngIf="editingDpi !== toStringVal(p.DPI)">
            <a *ngIf="p.Telefono" [href]="'tel:'+p.Telefono" class="text-decoration-none">
              <i class="fas fa-phone me-1 text-muted"></i>{{ p.Telefono }}
            </a>
            <span *ngIf="!p.Telefono" class="text-muted">—</span>
          </td>
          <td class="d-none d-sm-table-cell" *ngIf="editingDpi === toStringVal(p.DPI)">
            <input type="text" class="form-control form-control-sm" [(ngModel)]="editTelefono" />
          </td>

          <td *ngIf="editingDpi !== toStringVal(p.DPI)" [class.sorted-col]="isSortedField('correo')">
            <ng-container *ngIf="p.Correo; else noMail">
              <a [href]="'mailto:'+p.Correo" class="text-decoration-none">
                <i class="fas fa-envelope me-1 text-muted"></i>{{ p.Correo }}
              </a>
              <button class="btn btn-link btn-sm py-0 ms-1" title="Copiar" (click)="copy(p.Correo)"><i class="fas fa-copy"></i></button>
            </ng-container>
            <ng-template #noMail><span class="text-muted">—</span></ng-template>
          </td>
          <td *ngIf="editingDpi === toStringVal(p.DPI)">
            <input type="email" class="form-control form-control-sm" [(ngModel)]="editCorreo" />
          </td>

          <td class="d-none d-md-table-cell">
            <span class="badge" [ngClass]="(p.Activo || '').toUpperCase() === 'SI' ? 'bg-success' : 'bg-secondary'">
              <i class="fas" [ngClass]="(p.Activo || '').toUpperCase() === 'SI' ? 'fa-check' : 'fa-minus'" ></i>
              {{ (p.Activo || '').toUpperCase() === 'SI' ? 'Activo' : 'Inactivo' }}
            </span>
          </td>

          <td>
            <div class="btn-group btn-group-sm" *ngIf="editingDpi !== toStringVal(p.DPI); else editActions">
              <button class="btn btn-outline-primary" (click)="startEdit(p)"><i class="fas fa-pen me-1"></i>Editar</button>
            </div>
            <ng-template #editActions>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-success" (click)="saveEdit()">Guardar</button>
                <button class="btn btn-outline-secondary" (click)="cancelEdit()">Cancelar</button>
              </div>
            </ng-template>
          </td>
        </tr>
        <tr *ngIf="!loading && filtered.length === 0">
          <td colspan="6" class="text-center text-muted py-4">No se encontraron pacientes.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex align-items-center justify-content-between mt-3">
  <div class="text-muted">Mostrando {{ (page - 1) * pageSize + 1 }} - {{ min(page * pageSize, filtered.length) }} de {{ filtered.length }}</div>
    <div class="btn-group">
      <button class="btn btn-outline-secondary" (click)="prevPage()" [disabled]="page <= 1">Anterior</button>
      <button class="btn btn-outline-secondary" (click)="nextPage()" [disabled]="page >= totalPages">Siguiente</button>
    </div>
  </div>
</div>
