<div class="container-xxl py-3">
  <!-- Toolbar principal: título, crear, buscar, filtros, refrescar -->
  <div class="toolbar d-flex align-items-center justify-content-between p-2 mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <h5 class="m-0">Pacientes</h5>
      <app-user-create-panel [allowedTabs]="['paciente']" [createLabel]="'Crear paciente'"></app-user-create-panel>
    </div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="input-group">
        <input type="text" class="form-control" [(ngModel)]="search" (ngModelChange)="applyFilters()" placeholder="Buscar por nombre, DPI, correo o teléfono" />
      </div>
      <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()" style="min-width:150px">
        <option value="todos">Todos</option>
        <option value="activos">Activos</option>
        <option value="inactivos">Inactivos</option>
      </select>
      <select class="form-select" [(ngModel)]="sortBy" (change)="applyFilters()" style="min-width:170px">
        <option value="apellidos">Ordenar por Apellidos</option>
        <option value="nombres">Ordenar por Nombres</option>
        <option value="dpi">Ordenar por DPI</option>
        <option value="correo">Ordenar por Correo</option>
      </select>
      <select class="form-select" [(ngModel)]="sortDir" (change)="applyFilters()" style="min-width:140px">
        <option value="asc">Ascendente</option>
        <option value="desc">Descendente</option>
      </select>
      <select class="form-select" [(ngModel)]="pageSize" (change)="changePageSize()" style="min-width:120px">
        <option *ngFor="let o of pageSizeOptions" [value]="o">{{ o }} / pág</option>
      </select>
      <button class="btn btn-outline-success" (click)="loadPatients()">Refrescar</button>
    </div>
  </div>

  <div class="mb-2 d-flex flex-wrap gap-2">
    <span class="badge-soft primary">Total: {{ totalCount }}</span>
    <span class="badge-soft success">Activos: {{ activeCount }}</span>
    <span class="badge-soft danger">Inactivos: {{ inactiveCount }}</span>
  </div>
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover segmented table-card table-modern align-middle mb-0 w-100 text-center">
          <thead class="position-sticky top-0" style="z-index:1">
        <tr>
          <th (click)="setSort('dpi')" class="sortable col-dpi" [class.sorted-col]="isSortedField('dpi')">DPI <span class="arrow">{{ sortArrow('dpi') }}</span></th>
          <th (click)="setSort('apellidos')" class="sortable col-nombre" [class.sorted-col]="isSortedField('apellidos') || isSortedField('nombres')">Nombre <span class="arrow">{{ sortArrow('apellidos') }}</span></th>
          <th class="d-none d-sm-table-cell col-tel">Teléfono</th>
          <th (click)="setSort('correo')" class="sortable col-correo" [class.sorted-col]="isSortedField('correo')">Correo <span class="arrow">{{ sortArrow('correo') }}</span></th>
          <th class="d-none d-md-table-cell col-estado">Estado</th>
          <th class="col-acciones">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Skeleton rows while loading -->
        <ng-container *ngIf="loading">
          <tr *ngFor="let _ of skeletonRows">
            <td class="text-nowrap"><div class="sk sk-text w-75"></div></td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="sk sk-avatar"></div>
                <div class="flex-grow-1">
                  <div class="sk sk-text w-50 mb-1"></div>
                  <div class="sk sk-text w-25"></div>
                </div>
              </div>
            </td>
            <td class="d-none d-sm-table-cell"><div class="sk sk-text w-50"></div></td>
            <td><div class="sk sk-text w-75"></div></td>
            <td class="d-none d-md-table-cell"><div class="sk sk-badge w-50"></div></td>
            <td>
              <div class="d-flex gap-2">
                <div class="sk sk-btn"></div>
                <div class="sk sk-btn"></div>
              </div>
            </td>
          </tr>
        </ng-container>

        <!-- Real rows when not loading -->
        <tr *ngFor="let p of paged" [class.d-none]="loading">
          <td class="text-nowrap col-dpi" [class.sorted-col]="isSortedField('dpi')" data-label="DPI">{{ p.DPI }}</td>
          <td class="col-nombre" [class.sorted-col]="isSortedField('apellidos') || isSortedField('nombres')" data-label="Nombre">
            <div class="fw-semibold d-flex align-items-center justify-content-center gap-2 text-center">
              <div class="avatar text-white d-inline-flex align-items-center justify-content-center" [ngStyle]="avatarStyle(p)">
                {{ initials(p) }}
              </div>
              <span>{{ p.Nombres }} {{ p.Apellidos }}</span>
            </div>
            <small class="text-muted d-sm-none text-center">Tel: {{ p.Telefono || '—' }}</small>
            <div class="small text-muted text-center">DPI: {{ p.DPI }}</div>
          </td>
          <td class="d-none d-sm-table-cell col-tel" *ngIf="editingDpi !== toStringVal(p.DPI)" data-label="Teléfono">
            <a *ngIf="p.Telefono" [href]="'tel:'+p.Telefono" class="text-decoration-none">
              <i class="fas fa-phone me-1 text-muted"></i>{{ p.Telefono }}
            </a>
            <span *ngIf="!p.Telefono" class="text-muted">—</span>
          </td>
          <td class="d-none d-sm-table-cell col-tel" *ngIf="editingDpi === toStringVal(p.DPI)" data-label="Teléfono">
            <input type="text" class="form-control form-control-sm w-100" [(ngModel)]="editTelefono" />
          </td>

          <td class="col-correo" *ngIf="editingDpi !== toStringVal(p.DPI)" [class.sorted-col]="isSortedField('correo')" data-label="Correo">
            <ng-container *ngIf="p.Correo; else noMail">
              <a [href]="'mailto:'+p.Correo" class="text-decoration-none">
                <i class="fas fa-envelope me-1 text-muted"></i>{{ p.Correo }}
              </a>
              <button class="btn btn-link btn-sm py-0 ms-1" title="Copiar" (click)="copy(p.Correo)"><i class="fas fa-copy"></i></button>
            </ng-container>
            <ng-template #noMail><span class="text-muted">—</span></ng-template>
          </td>
          <td class="col-correo" *ngIf="editingDpi === toStringVal(p.DPI)" data-label="Correo">
            <input type="email" class="form-control form-control-sm w-100" [(ngModel)]="editCorreo" />
          </td>

          <td class="d-none d-md-table-cell col-estado" data-label="Estado">
            <span class="badge-soft" [ngClass]="(p.Activo || '').toUpperCase() === 'SI' ? 'success' : 'danger'">
              {{ (p.Activo || '').toUpperCase() === 'SI' ? 'Activo' : 'Inactivo' }}
            </span>
          </td>

          <td class="col-acciones" data-label="Acciones">
            <div class="btn-group btn-group-sm" *ngIf="editingDpi !== toStringVal(p.DPI); else editActions">
              <button class="btn btn-outline-primary" (click)="startEdit(p)"><i class="fas fa-pen me-1"></i>Editar</button>
            </div>
            <ng-template #editActions>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-success" (click)="saveEdit()">Guardar</button>
                <button class="btn btn-outline-secondary" (click)="cancelEdit()">Cancelar</button>
              </div>
            </ng-template>
          </td>
        </tr>
        <tr *ngIf="!loading && filtered.length === 0">
          <td colspan="6" class="text-center text-muted py-4">No se encontraron pacientes.</td>
        </tr>
      </tbody>
        </table>
      </div>

      <div class="d-flex align-items-center justify-content-between mt-3 flex-wrap gap-2">
        <div class="text-muted small">Mostrando {{ (page - 1) * pageSize + 1 }} - {{ min(page * pageSize, filtered.length) }} de {{ filtered.length }}</div>
        <!-- Paginación moderna con números -->
        <nav *ngIf="totalPages > 1" aria-label="Paginación de pacientes">
          <ul class="pagination justify-content-center pagination-modern mb-0">
            <li class="page-item" [class.disabled]="page === 1">
              <a class="page-link" href="javascript:void(0)" (click)="page > 1 && (page = page - 1)" aria-label="Anterior">
                <i class="bi bi-chevron-left"></i>
                <span class="d-none d-sm-inline">Anterior</span>
              </a>
            </li>
            <li *ngFor="let _ of [].constructor(totalPages); let i = index" class="page-item" [class.active]="page === i + 1">
              <a class="page-link" href="javascript:void(0)" (click)="page = i + 1" [attr.aria-label]="'Ir a página ' + (i + 1)">{{ i + 1 }}</a>
            </li>
            <li class="page-item" [class.disabled]="page === totalPages">
              <a class="page-link" href="javascript:void(0)" (click)="page < totalPages && (page = page + 1)" aria-label="Siguiente">
                <span class="d-none d-sm-inline">Siguiente</span>
                <i class="bi bi-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
