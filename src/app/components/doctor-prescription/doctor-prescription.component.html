<div class="container-xxl py-3">
  <div class="toolbar d-flex align-items-center justify-content-between p-2 mb-3 flex-wrap gap-2">
    <h5 class="m-0">Generación de receta</h5>
  </div>

  <!-- Formulario -->
  <form [formGroup]="form" class="card">
    <div class="card-body">
      <div class="row g-3 mb-3">
        <div class="col-sm-4">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" formControlName="fecha">
        </div>
        <div class="col-sm-8">
          <label class="form-label">Doctor</label>
          <input type="text" class="form-control" [value]="doctorName" disabled>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-12 col-md-8">
          <label class="form-label">Paciente</label>
          <select class="form-control" formControlName="pacienteDPI">
            <option value="" disabled>Seleccione un paciente</option>
            <option *ngFor="let p of patients" [value]="p.DPI">
              {{ (p.Nombres || p.nombres || '') + ' ' + (p.Apellidos || p.apellidos || '') }} — DPI: {{ p.DPI }}
            </option>
          </select>
        </div>
      </div>

      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="m-0">Medicamentos</h6>
        <button type="button" class="btn btn-outline-primary btn-sm" (click)="addItem()" [disabled]="items.length >= maxItems">Agregar ítem</button>
      </div>

      <!-- Encabezado de columnas con mismas proporciones que las filas -->
      <div class="rx-head small text-muted mb-1">
        <div class="qty">Cantidad</div>
        <div class="name">Medicamento</div>
        <div class="dose">Dosis</div>
        <div class="actions"></div>
      </div>

      <div formArrayName="items" class="rx-items">
        <ng-container *ngFor="let it of items.controls; let i = index">
          <div class="rx-row mb-2" [formGroupName]="i">
            <div class="qty">
              <input type="number" class="form-control" placeholder="0.00" step="0.01" min="0.01" formControlName="cantidad">
            </div>
            <div class="name position-relative">
              <input type="text" class="form-control" placeholder="Nombre del medicamento" formControlName="nombre" (input)="onNameInput(i)" autocomplete="off">
              <ul class="list-group suggestions" *ngIf="(suggestions[i] || []).length > 0">
                <li class="list-group-item list-group-item-action" *ngFor="let s of suggestions[i]" (click)="applySuggestion(i, s)">{{ s }}</li>
              </ul>
            </div>
            <div class="dose">
              <input type="text" class="form-control" placeholder="Indicaciones / Dosis" formControlName="dosis">
            </div>
            <div class="actions text-end">
              <button type="button" class="btn btn-outline-danger" (click)="removeItem(i)" [disabled]="items.length <= 1" title="Eliminar"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="mt-3 obs-container">
        <label class="form-label d-block mb-1">Observaciones adicionales (opcional)</label>
        <textarea class="form-control" rows="3" formControlName="observaciones" placeholder="Indicaciones adicionales"></textarea>
      </div>
      <div class="mt-3 text-end">
        <button class="btn btn-primary" type="button" (click)="generatePdf()" [disabled]="!canGenerate()">
          <span *ngIf="isGenerating" class="spinner-border spinner-border-sm me-1"></span>
          Generar PDF
        </button>
      </div>
    </div>
  </form>

  <!-- Plantilla para PDF fuera de vista (necesaria para render con html2canvas) -->
  <div id="rx-sheet" class="rx-sheet print-template visually-hidden">
    <div class="rx-header d-flex align-items-start justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <img [src]="logoPath" alt="logo" class="rx-logo">
        <div>
          <div class="fw-semibold">Centro Dermatológico</div>
          <div class="small">{{ clinicAddress }}</div>
          <div class="small">Teléfono: {{ clinicPhone }}</div>
          <div class="small">Correo: {{ doctorEmail }}</div>
        </div>
      </div>
      <div class="text-end small">
        <div><strong>Dr(a). {{ doctorName }}</strong></div>
        <div>Fecha: {{ form.get('fecha')?.value }}</div>
      </div>
    </div>
    <hr>
    <div class="small"><strong>Paciente</strong> __________________________________________</div>

    <div class="rx-body mt-3">
      <div class="rx-item" *ngFor="let it of items.controls; let i = index">
        <div><strong>{{ it.get('nombre')?.value || '—' }}</strong></div>
        <div class="small">{{ it.get('cantidad')?.value || '—' }} unidades</div>
        <div class="small">{{ it.get('dosis')?.value || '—' }}</div>
        <div class="divider"></div>
      </div>
      <div class="mt-3" *ngIf="form.get('observaciones')?.value">
        <div class="fw-semibold mb-1">Otras indicaciones</div>
        <div class="small">{{ form.get('observaciones')?.value }}</div>
      </div>
    </div>

  <div class="small mt-2"><strong>Paciente:</strong> {{ (getSelectedPatient()?.Nombres || getSelectedPatient()?.nombres || '') + ' ' + (getSelectedPatient()?.Apellidos || getSelectedPatient()?.apellidos || '') }} — DPI: {{ form.get('pacienteDPI')?.value || '—' }}</div>

    

    <div class="rx-footer">
      <div class="signature"></div>
      <div class="small text-center">Firma Dr(a). {{ doctorName }}</div>
    </div>
  </div>
</div>
