<!-- components/appointment-view/appointment-view.component.html -->
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Consultar Cita</h4>
        </div>
        <div class="card-body">
          <!-- Formulario de búsqueda -->
          <div class="form-group">
            <label for="appointmentId">Número de Cita</label>
            <div class="input-group toolbar p-2">
              <input
                type="number"
                class="form-control"
                id="appointmentId"
                [(ngModel)]="appointmentId"
                placeholder="Ingrese el número de cita"
              >
              <div class="input-group-append">
                <button
                  class="btn btn-primary"
                  type="button"
                  (click)="searchAppointment()"
                  [disabled]="!appointmentId || loading"
                >
                  <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                  Buscar
                </button>
              </div>
            </div>
          </div>

          <!-- Mensajes de error -->
          <div *ngIf="errorMessage" class="alert alert-danger">
            {{ errorMessage }}
          </div>

          <!-- Resultados -->
          <div *ngIf="found && appointment" class="mt-4">
            <div class="app-card">
              <div class="header d-flex justify-content-between align-items-center">
                <div>
                  <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden>
                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h.5A1.5 1.5 0 0 1 15 2.5v11A1.5 1.5 0 0 1 13.5 15h-11A1.5 1.5 0 0 1 1 13.5v-11A1.5 1.5 0 0 1 2.5 1H3V.5A.5.5 0 0 1 3.5 0zM2 4v9.5a.5.5 0 0 0 .5.5H13.5a.5.5 0 0 0 .5-.5V4H2z"/>
                    <path d="M10.854 7.146a.5.5 0 0 0-.708 0L8.5 8.793 7.854 8.146a.5.5 0 1 0-.708.708l1 1a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0 0-.708z"/>
                  </svg>
                  <span class="h5 mb-0">Cita #{{ appointment.idCitas }}</span>
                </div>
                <div>
                  <span class="badge-status" [ngClass]="{
                    'badge-confirmada': appointment.Confirmado === 'Confirmada',
                    'badge-pendiente': appointment.Confirmado === 'Pendiente',
                    'badge-cancelada': appointment.Confirmado === 'Cancelada'
                  }">
                    <ng-container>
                      <svg *ngIf="appointment.Confirmado === 'Confirmada'" class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.146 5.146a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 9.793l3.646-3.647z"/></svg>
                      <svg *ngIf="appointment.Confirmado === 'Pendiente'" class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 3.5a.5.5 0 0 1 .5.5v4.25l2.5 1.5a.5.5 0 0 1-.5.866L8 9V4a.5.5 0 0 1 .5-.5z"/></svg>
                      <svg *ngIf="appointment.Confirmado === 'Cancelada'" class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.536 11.95L11.95 12.536 8 8.586 4.05 12.536 3.464 11.95 7.414 8 3.464 4.05 4.05 3.464 8 7.414l3.95-3.95.586.586L8.586 8l3.95 3.95z"/></svg>
                    </ng-container>
                    <span>{{ appointment.Confirmado }}</span>
                  </span>
                </div>
              </div>

              <div class="subheader">Paciente</div>
              <div class="section">
                <div class="row">
                  <div class="col">
                    <div class="info-line"><strong>Nombre:</strong> {{ appointment.patientNames }} {{ appointment.patientLastNames }}</div>
                    <div class="info-line"><strong>DPI:</strong> {{ appointment.patientDpi }}</div>
                    <div class="info-line"><strong>Teléfono:</strong> {{ appointment.patientPhone }}</div>
                    <div class="info-line"><strong>Email:</strong> {{ appointment.patientEmail }}</div>
                  </div>
                </div>
              </div>

              <div class="subheader">Detalles de la Cita</div>
              <div class="section">
                <div class="row">
                  <div class="col-md-4 col">
                    <div class="info-line"><strong>Fecha:</strong> {{ appointment.Fecha | date:'dd/MM/yyyy' }}</div>
                    <div class="info-line"><strong>Hora:</strong> {{ appointment.Hora ? (appointment.Hora | slice:0:5) : '' }}</div>
                  </div>
                  <div class="col-md-8 col">
                    <div class="info-line"><strong>Especialidad:</strong> {{ appointment.specialtyName }}</div>
                    <div class="info-line"><strong>Doctor:</strong> Dr. {{ appointment.doctorName }} {{ appointment.doctorLastNames }}</div>
                  </div>
                </div>
              </div>

              <div *ngIf="appointment.observaciones" class="subheader">Observaciones</div>
              <div *ngIf="appointment.observaciones" class="section">
                <div class="info-line">{{ appointment.observaciones }}</div>
              </div>

              <div class="action-row">
                <button class="btn btn-success" (click)="confirmAppointment()" *ngIf="appointment.Confirmado === 'Pendiente'" [disabled]="actionLoading">
                  <span *ngIf="actionLoading" class="spinner-border spinner-border-sm me-2"></span>
                  <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M2 2.5a.5.5 0 0 1 .5-.5H6v1H3v10h10V3h-3V2h3.5a.5.5 0 0 1 .5.5v10a1 1 0 0 1-1 1H4.5a1 1 0 0 1-1-1v-10z"/></svg>
                  Confirmar Cita
                </button>
                <button class="btn btn-danger" (click)="cancelAppointment()" *ngIf="appointment.Confirmado === 'Pendiente' || appointment.Confirmado === 'Confirmada'" [disabled]="actionLoading">
                  <span *ngIf="actionLoading" class="spinner-border spinner-border-sm me-2"></span>
                  <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm3.536 10.95L11.95 12.536 8 8.586 4.05 12.536 3.464 11.95 7.414 8 3.464 4.05 4.05 3.464 8 7.414l3.95-3.95.586.586L8.586 8l3.95 3.95z"/></svg>
                  Cancelar Cita
                </button>
                <button class="btn btn-primary" (click)="generateTicket()" [disabled]="actionLoading"> 
                  <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M5 0h6a1 1 0 0 1 1 1v14l-3-1-3 1V1a1 1 0 0 1 1-1z"/></svg>
                  Descargar Comprobante
                </button>
                <button class="btn btn-outline-secondary" (click)="clearSearch()" [disabled]="actionLoading"> 
                  <svg class="icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1zM8 4v4l3 1"/></svg>
                  Nueva Búsqueda
                </button>
              </div>

              <!-- toasts shown globally via ToastService -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>