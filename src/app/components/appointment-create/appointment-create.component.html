<!-- appointment-create.component.html -->
<div class="container mt-4">
  <!-- Toolbar/header -->
  <div class="toolbar d-flex align-items-center justify-content-between p-3 mb-3">
    <h2 class="m-0">Crear Nueva Cita</h2>
    <button type="button" class="btn btn-outline-secondary ms-2" (click)="resetForm()">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6V4l-4 4 4 4V8c2.757 0 5 2.243 5 5a4.997 4.997 0 0 1-4 4.9v2.021A7.002 7.002 0 0 0 19 13c0-3.86-3.141-7-7-7z"/></svg>
      Limpiar
    </button>
  </div>
  
  <form class="appointment-form" [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" autocomplete="off">
    <!-- Datos del paciente -->
    <div class="card mb-3">
      <div class="card-header">Datos del Paciente</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>DPI</label>
              <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="13"
                class="form-control"
                formControlName="patientDpi"
                placeholder="Ingrese 13 dígitos"
                (blur)="onPatientDpiBlur()">
              <div *ngIf="appointmentForm.get('patientDpi')?.invalid && appointmentForm.get('patientDpi')?.touched" 
                   class="text-danger">
                DPI debe tener 13 dígitos
              </div>
              <div class="form-text text-muted">Al ingresar un DPI válido, se cargarán automáticamente los datos del paciente.</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Teléfono</label>
              <input type="tel" class="form-control" formControlName="patientPhone" placeholder="Cargado automáticamente" [disabled]="true">
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Nombres</label>
              <input type="text" class="form-control" formControlName="patientNames" placeholder="Cargado automáticamente" [disabled]="true">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Apellidos</label>
              <input type="text" class="form-control" formControlName="patientLastNames" placeholder="Cargado automáticamente" [disabled]="true">
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Correo Electrónico</label>
          <input type="email" class="form-control" formControlName="patientEmail" placeholder="Cargado automáticamente" [disabled]="true">
        </div>
      </div>
    </div>
    
    <!-- Detalles de la cita -->
    <div class="card mb-3">
      <div class="card-header">Detalles de la Cita</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Especialidad</label>
              <select class="form-control" formControlName="specialty">
                <option [ngValue]="null">Seleccione una especialidad</option>
                <option *ngFor="let specialty of specialties" [ngValue]="specialty.idEspecialidades">
                  {{specialty.Nombre}}
                </option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Doctor</label>
              <select class="form-control" formControlName="doctor" [disabled]="!appointmentForm.get('specialty')?.value || loadingDoctors || doctors.length === 0">
                <option value="">Seleccione un doctor</option>
                <option *ngFor="let doctor of doctors" [ngValue]="doctor.Colegiado || doctor.colegiado || doctor.id || doctor.idDoctor">
                  Dr. {{ (doctor.Nombres || doctor.nombres || doctor.nombre || doctor.firstName || '') }} {{ (doctor.Apellidos || doctor.apellidos || doctor.lastName || '') }}
                </option>
              </select>
              <div *ngIf="!loadingDoctors && appointmentForm.get('specialty')?.value && doctors.length === 0" class="mt-2">
                <small class="text-muted">No hay doctores disponibles para esta especialidad.</small>
              </div>
              <div *ngIf="loadingDoctors" class="mt-2">
                <small class="text-muted">Cargando doctores...</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label>Fecha</label>
              <input type="date" class="form-control" formControlName="date" [min]="minDate">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label>Hora</label>
              <select class="form-control" formControlName="time">
                <option value="">Seleccione una hora</option>
                <option *ngFor="let hora of availableTimes" [value]="hora">{{hora}}</option>
              </select>
              <div *ngIf="appointmentForm.get('time')?.hasError('notAvailable')" class="text-danger mt-1">
                El doctor no está disponible en esa hora. Seleccione otra.
              </div>
              <div *ngIf="appointmentForm.get('doctor')?.value && appointmentForm.get('date')?.value && availableTimes.length === 0" class="text-muted mt-1">
                No hay horas disponibles para la fecha seleccionada.
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Observaciones</label>
          <textarea class="form-control" formControlName="observations" rows="3"></textarea>
        </div>
      </div>
    </div>
    
    <button type="submit" class="btn btn-primary" [disabled]="!canSubmitFlag">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H5V9h14v9zM7 11h5v5H7z"/></svg>
      <span *ngIf="!actionLoading">Crear Cita</span>
      <span *ngIf="actionLoading" class="d-inline-flex align-items-center">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Creando...
      </span>
    </button>
  </form>
</div>

<!-- toasts shown globally via ToastService -->