<div class="admin-appointments p-2">
  <!-- Toolbar global -->
  <div class="toolbar d-flex align-items-center justify-content-between p-2 mb-3 flex-wrap gap-2">
    <h5 class="m-0">Administración de Citas</h5>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="input-group">
        <input type="text" class="form-control" [(ngModel)]="searchTerm" placeholder="Buscar por paciente, doctor, número, estado..." />
      </div>
      <button class="btn btn-outline-success" (click)="refreshAll()">Refrescar</button>
    </div>
  </div>
  
  <div class="grid">
    <!-- Hoy -->
    <section class="card ficha">
    <header class="card-header card-header--brand">Hoy <small class="muted">({{ today | date:'dd/MM/yyyy' }})</small> <span class="badge">{{ filteredHoy.length }}</span></header>
      <div class="card-body">
  <div class="section-subtitle">Mostrando {{ (uiPageHoy-1)*uiLimitHoy + 1 }}–{{ min(uiPageHoy*uiLimitHoy, filteredHoy.length) }} de {{ filteredHoy.length }}</div>
        <div class="table-scroll">
  <table class="table table-sm mb-1 app-table app-table--minwidth table-modern table-card">
          <thead>
            <tr>
              <th class="col-patient">Paciente</th>
              <th class="col-phone">Teléfono</th>
              <th class="col-spec">Especialidad</th>
              <th class="col-doctor">Doctor</th>
              <th class="col-status">Estado</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of filteredHoy | slice:(uiPageHoy-1)*uiLimitHoy:(uiPageHoy)*uiLimitHoy">
              <td class="patient-cell" data-label="Paciente" [title]="(c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-'">
                <div class="text-wrap">{{ (c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-' }}</div>
              </td>
              <td data-label="Teléfono" class="col-phone">{{ formatPhone(getPhone(c)) }}</td>
              <td data-label="Especialidad" class="text-wrap">{{ c.especialidadInfo?.Nombre || c.consulta_Especialidad || '-' }}</td>
              <td data-label="Doctor" class="doctor-cell text-wrap" [title]="c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-')">{{ c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-') }}</td>
              <td data-label="Estado" class="col-status"><span class="status-badge" [ngClass]="getStatusClass(c)">{{ formatEstado(c) }}</span></td>
              <td class="col-actions">
                <button *ngIf="isPendiente(c)" type="button" class="btn btn-sm btn-accept me-1" (click)="openActionModal('confirm', c)">Confirmar</button>
                <button *ngIf="isPendiente(c)" type="button" class="btn btn-sm btn-cancel" (click)="openActionModal('cancel', c)">Cancelar</button>
              </td>
            </tr>
            <tr *ngIf="filteredHoy.length === 0"><td colspan="6" class="text-center text-muted">No hay citas hoy</td></tr>
          </tbody>
        </table>
        </div>
  <div class="table-footer toolbar p-2">
          <div class="pager">
            <button class="btn btn-ghost" (click)="prevPage('hoy')" [disabled]="uiPageHoy===1">Anterior</button>
            <span>Página {{ uiPageHoy }} de {{ getTotalPages('hoy') }}</span>
            <button class="btn btn-ghost" (click)="nextPage('hoy')" [disabled]="uiPageHoy>=getTotalPages('hoy')">Siguiente</button>
          </div>
          <div class="page-size">
            <label>Por página</label>
            <select [ngModel]="uiLimitHoy" (ngModelChange)="changeLimit('hoy', $event)">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Próximas 7 días -->
    <section class="card ficha">
    <header class="card-header card-header--brand">Próximos 7 días <span class="badge">{{ filteredProx.length }}</span></header>
      <div class="card-body">
  <div class="section-subtitle">Mostrando {{ (uiPageProx-1)*uiLimitProx + 1 }}–{{ min(uiPageProx*uiLimitProx, filteredProx.length) }} de {{ filteredProx.length }}</div>
        <div class="table-scroll">
  <table class="table table-sm mb-1 app-table app-table--minwidth table-modern table-card">
          <thead>
            <tr>
              <th class="col-date">Fecha</th>
              <th class="col-num">Número</th>
              <th class="col-patient">Paciente</th>
              <th class="col-phone">Teléfono</th>
              <th class="col-spec">Especialidad</th>
              <th class="col-doctor">Doctor</th>
              <th class="col-status">Estado</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of filteredProx | slice:(uiPageProx-1)*uiLimitProx:(uiPageProx)*uiLimitProx">
              <td data-label="Fecha" class="col-date">{{ c.fecha | date:'dd/MM/yyyy' }}</td>
              <td data-label="Número" class="col-num">{{ c.numero || c.CitaNumero || '-' }}</td>
              <td class="patient-cell" data-label="Paciente" [title]="(c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-'">
                <div class="text-wrap">{{ (c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-' }}</div>
              </td>
              <td data-label="Teléfono" class="col-phone">{{ formatPhone(getPhone(c)) }}</td>
              <td data-label="Especialidad" class="text-wrap">{{ c.especialidadInfo?.Nombre || '-' }}</td>
              <td data-label="Doctor" class="doctor-cell text-wrap" [title]="c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-')">{{ c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-') }}</td>
              <td data-label="Estado" class="col-status"><span class="status-badge" [ngClass]="getStatusClass(c)">{{ formatEstado(c) }}</span></td>
              <td class="col-actions">
                <button *ngIf="isPendiente(c)" type="button" class="btn btn-sm btn-accept me-1" (click)="openActionModal('confirm', c)">Confirmar</button>
                <button *ngIf="isPendiente(c)" type="button" class="btn btn-sm btn-cancel" (click)="openActionModal('cancel', c)">Cancelar</button>
              </td>
            </tr>
            <tr *ngIf="filteredProx.length === 0"><td colspan="8" class="text-center text-muted">No hay citas próximas</td></tr>
          </tbody>
        </table>
        </div>
  <div class="table-footer toolbar p-2">
          <div class="pager">
            <button class="btn btn-ghost" (click)="prevPage('prox')" [disabled]="uiPageProx===1">Anterior</button>
            <span>Página {{ uiPageProx }} de {{ getTotalPages('prox') }}</span>
            <button class="btn btn-ghost" (click)="nextPage('prox')" [disabled]="uiPageProx>=getTotalPages('prox')">Siguiente</button>
          </div>
          <div class="page-size">
            <label>Por página</label>
            <select [ngModel]="uiLimitProx" (ngModelChange)="changeLimit('prox', $event)">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Pendientes -->
    <section class="card ficha">
    <header class="card-header card-header--brand">Pendientes <span class="badge">{{ filteredPend.length }}</span></header>
      <div class="card-body">
  <div class="section-subtitle">Mostrando {{ (uiPagePend-1)*uiLimitPend + 1 }}–{{ min(uiPagePend*uiLimitPend, filteredPend.length) }} de {{ filteredPend.length }}</div>
        <div class="table-scroll">
  <table class="table table-sm mb-1 app-table app-table--minwidth table-modern table-card">
          <thead>
            <tr>
              <th class="col-date">Fecha</th>
              <th class="col-num">Número</th>
              <th class="col-patient">Paciente</th>
              <th class="col-phone">Teléfono</th>
              <th class="col-doctor">Doctor</th>
              <th class="col-spec">Especialidad</th>
              <th class="col-status">Estado</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of filteredPend | slice:(uiPagePend-1)*uiLimitPend:(uiPagePend)*uiLimitPend">
              <td data-label="Fecha" class="col-date">{{ c.fecha ? (c.fecha | date:'dd/MM/yyyy') : '-' }}</td>
              <td data-label="Número" class="col-num">{{ c.numero || c.CitaNumero || '-' }}</td>
              <td class="patient-cell" data-label="Paciente" [title]="(c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-'">
                <div class="text-wrap">{{ (c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-' }}</div>
              </td>
              <td data-label="Teléfono" class="col-phone">{{ formatPhone(getPhone(c)) }}</td>
              <td data-label="Doctor" class="doctor-cell text-wrap" [title]="c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-')">{{ c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-') }}</td>
              <td data-label="Especialidad" class="text-wrap">{{ c.especialidadInfo?.Nombre || '-' }}</td>
              <td data-label="Estado" class="col-status"><span class="status-badge" [ngClass]="getStatusClass(c)">{{ formatEstado(c) }}</span></td>
              <td class="col-actions">
                <button type="button" class="btn btn-sm btn-accept me-1" (click)="openActionModal('confirm', c)">Confirmar</button>
                <button type="button" class="btn btn-sm btn-cancel" (click)="openActionModal('cancel', c)">Cancelar</button>
              </td>
            </tr>
            <tr *ngIf="filteredPend.length === 0"><td colspan="8" class="text-center text-muted">No hay citas pendientes</td></tr>
          </tbody>
        </table>
        </div>
  <div class="table-footer toolbar p-2">
          <div class="pager">
            <button class="btn btn-ghost" (click)="prevPage('pend')" [disabled]="uiPagePend===1">Anterior</button>
            <span>Página {{ uiPagePend }} de {{ getTotalPages('pend') }}</span>
            <button class="btn btn-ghost" (click)="nextPage('pend')" [disabled]="uiPagePend>=getTotalPages('pend')">Siguiente</button>
          </div>
          <div class="page-size">
            <label>Por página</label>
            <select [ngModel]="uiLimitPend" (ngModelChange)="changeLimit('pend', $event)">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Confirmadas -->
    <section class="card ficha">
    <header class="card-header card-header--brand">Confirmadas <span class="badge">{{ filteredConf.length }}</span></header>
      <div class="card-body">
  <div class="section-subtitle">Mostrando {{ (uiPageConf-1)*uiLimitConf + 1 }}–{{ min(uiPageConf*uiLimitConf, filteredConf.length) }} de {{ filteredConf.length }}</div>
        <div class="table-scroll">
  <table class="table table-sm mb-1 app-table app-table--minwidth table-modern table-card">
          <thead>
            <tr>
              <th class="col-date">Fecha</th>
              <th class="col-num">Número</th>
              <th class="col-patient">Paciente</th>
              <th class="col-phone">Teléfono</th>
              <th class="col-doctor">Doctor</th>
              <th class="col-spec">Especialidad</th>
              <th class="col-status">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of filteredConf | slice:(uiPageConf-1)*uiLimitConf:(uiPageConf)*uiLimitConf">
              <td data-label="Fecha" class="col-date">{{ c.fecha ? (c.fecha | date:'dd/MM/yyyy') : '-' }}</td>
              <td data-label="Número" class="col-num">{{ c.numero || c.CitaNumero || '-' }}</td>
              <td class="patient-cell" data-label="Paciente" [title]="(c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-'">
                <div class="text-wrap">{{ (c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-' }}</div>
              </td>
              <td data-label="Teléfono" class="col-phone">{{ formatPhone(getPhone(c)) }}</td>
              <td data-label="Doctor" class="doctor-cell text-wrap" [title]="c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-')">{{ c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-') }}</td>
              <td data-label="Especialidad" class="text-wrap">{{ c.especialidadInfo?.Nombre || '-' }}</td>
              <td data-label="Estado" class="col-status"><span class="status-badge" [ngClass]="getStatusClass(c)">{{ formatEstado(c) }}</span></td>
            </tr>
            <tr *ngIf="filteredConf.length === 0"><td colspan="7" class="text-center text-muted">No hay citas confirmadas</td></tr>
          </tbody>
        </table>
        </div>
  <div class="table-footer toolbar p-2">
          <div class="pager">
            <button class="btn btn-ghost" (click)="prevPage('conf')" [disabled]="uiPageConf===1">Anterior</button>
            <span>Página {{ uiPageConf }} de {{ getTotalPages('conf') }}</span>
            <button class="btn btn-ghost" (click)="nextPage('conf')" [disabled]="uiPageConf>=getTotalPages('conf')">Siguiente</button>
          </div>
          <div class="page-size">
            <label>Por página</label>
            <select [ngModel]="uiLimitConf" (ngModelChange)="changeLimit('conf', $event)">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Canceladas -->
    <section class="card ficha">
  <header class="card-header card-header--brand">Canceladas <span class="badge">{{ filteredCanc.length }}</span></header>
      <div class="card-body">
  <div class="section-subtitle">Mostrando {{ (uiPageCanc-1)*uiLimitCanc + 1 }}–{{ min(uiPageCanc*uiLimitCanc, filteredCanc.length) }} de {{ filteredCanc.length }}</div>
        <div class="table-scroll">
    <table class="table table-sm mb-1 app-table app-table--minwidth table-modern table-card">
          <thead>
            <tr>
              <th class="col-date">Fecha</th>
              <th class="col-num">Número</th>
              <th class="col-patient">Paciente</th>
              <th class="col-phone">Teléfono</th>
              <th class="col-doctor">Doctor</th>
              <th class="col-spec">Especialidad</th>
              <th class="col-status">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of filteredCanc | slice:(uiPageCanc-1)*uiLimitCanc:(uiPageCanc)*uiLimitCanc">
              <td class="col-date">{{ c.fecha ? (c.fecha | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="col-num">{{ c.numero || c.CitaNumero || '-' }}</td>
              <td class="patient-cell" [title]="(c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-'">
                <div class="text-wrap">{{ (c.pacienteInfo?.nombres ? (c.pacienteInfo.nombres + ' ' + (c.pacienteInfo.apellidos||'')) : (c.pacienteNombre || c.paciente || c.pacienteInfo?.nombre || c.pacienteInfo?.fullName)) || '-' }}</div>
              </td>
              <td data-label="Teléfono" class="col-phone">{{ formatPhone(getPhone(c)) }}</td>
              <td class="doctor-cell text-wrap" [title]="c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-')">{{ c.doctorInfo?.nombres ? (c.doctorInfo.nombres + ' ' + (c.doctorInfo.apellidos||'')) : (c.profesional_Responsable || '-') }}</td>
              <td class="text-wrap">{{ c.especialidadInfo?.Nombre || '-' }}</td>
              <td class="col-status"><span class="status-badge" [ngClass]="getStatusClass(c)">{{ formatEstado(c) }}</span></td>
            </tr>
            <tr *ngIf="filteredCanc.length === 0"><td colspan="7" class="text-center text-muted">No hay citas canceladas</td></tr>
          </tbody>
        </table>
        </div>
        <div class="table-footer">
          <div class="pager">
            <button class="btn btn-ghost" (click)="prevPage('canc')" [disabled]="uiPageCanc===1">Anterior</button>
            <span>Página {{ uiPageCanc }} de {{ getTotalPages('canc') }}</span>
            <button class="btn btn-ghost" (click)="nextPage('canc')" [disabled]="uiPageCanc>=getTotalPages('canc')">Siguiente</button>
          </div>
          <div class="page-size">
            <label>Por página</label>
            <select [ngModel]="uiLimitCanc" (ngModelChange)="changeLimit('canc', $event)">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- simple action modal -->
  <div *ngIf="actionModalOpen" class="modal-overlay">
    <div class="modal card">
      <div class="card-header">Confirmar acción</div>
      <div class="card-body">
  <p>Vas a <strong>{{ actionType === 'confirm' ? 'confirmar' : 'cancelar' }}</strong> la cita <strong>#{{ actionTarget?.idCitas || actionTarget?.numero || actionTarget?.CitaNumero || actionTarget?.id }}</strong>.</p>
                <div class="mb-2 small text-muted">
              <div>Fecha: {{ actionTarget?.fecha ? (actionTarget.fecha | date:'dd/MM/yyyy') : '-' }}</div>
              <div>Hora: {{ actionTarget?.hora || actionTarget?.Hora || '-' }}</div>
              <div>Teléfono paciente: {{ formatPhone(getPhone(actionTarget)) }}</div>
            </div>
        <div class="card-footer">
          <button type="button" class="btn btn-sm btn-accept me-2" (click)="performAction()" [disabled]="actionLoading">Aceptar</button>
          <button type="button" class="btn btn-sm btn-secondary" (click)="closeActionModal()" [disabled]="actionLoading">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

</div>
