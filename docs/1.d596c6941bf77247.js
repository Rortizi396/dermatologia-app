"use strict";(self.webpackChunkdermatologia_app=self.webpackChunkdermatologia_app||[]).push([[1],{6001:(L,p,l)=>{l.r(p),l.d(p,{DoctorPrescriptionComponent:()=>T});var x=l(4523),g=l(2200),s=l(9417),O=l(3985),F=l(7239),M=l.n(F),t=l(3664),m=l(2615),k=l(4796),y=l(8397),u=l(7673),h=l(9437),f=l(9330);let D=(()=>{class r{http;apiUrl=window.__env?.apiUrl||"/api";storageKey="med_catalog_local";constructor(e){this.http=e}search(e,o=10){const n=`${this.apiUrl}/medicamentos?q=${encodeURIComponent(e)}&limit=${o}`;return this.http.get(n).pipe((0,h.W)(()=>{const c=(this.readLocal()||[]).filter(a=>a.toLowerCase().includes(e.toLowerCase())).slice(0,o);return(0,u.of)({success:!0,data:c.map(a=>({nombre:a}))})}))}add(e){return this.http.post(`${this.apiUrl}/medicamentos`,{nombre:e}).pipe((0,h.W)(()=>{const n=new Set(this.readLocal());return n.add(e),this.writeLocal(Array.from(n.values())),(0,u.of)({success:!0})}))}readLocal(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch{return[]}}writeLocal(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch{}}static \u0275fac=function(o){return new(o||r)(m.KVO(f.Qq))};static \u0275prov=m.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var j=l(3711);const I=()=>[];function E(r,d){if(1&r&&(t.j41(0,"option",45),t.EFF(1),t.k0s()),2&r){const e=d.$implicit;t.Y8G("value",e.DPI),t.R7$(),t.Lme(" ",(e.Nombres||e.nombres||"")+" "+(e.Apellidos||e.apellidos||"")," \u2014 DPI: ",e.DPI," ")}}function w(r,d){if(1&r){const e=t.RV6();t.j41(0,"li",59),t.bIt("click",function(){const n=m.eBV(e).$implicit,i=t.XpG(2).index,c=t.XpG();return m.Njj(c.applySuggestion(i,n))}),t.EFF(1),t.k0s()}if(2&r){const e=d.$implicit;t.R7$(),t.JRh(e)}}function G(r,d){if(1&r&&(t.j41(0,"ul",57),t.DNE(1,w,2,1,"li",58),t.k0s()),2&r){const e=t.XpG().index,o=t.XpG();t.R7$(),t.Y8G("ngForOf",o.suggestions[e])}}function $(r,d){if(1&r){const e=t.RV6();t.j41(0,"tr",46)(1,"td",47),t.nrm(2,"input",48),t.k0s(),t.j41(3,"td",49)(4,"input",50),t.bIt("input",function(){const n=m.eBV(e).index,i=t.XpG();return m.Njj(i.onNameInput(n))}),t.k0s(),t.DNE(5,G,2,1,"ul",51),t.k0s(),t.j41(6,"td",52),t.nrm(7,"input",53),t.k0s(),t.j41(8,"td",54)(9,"button",55),t.bIt("click",function(){const n=m.eBV(e).index,i=t.XpG();return m.Njj(i.removeItem(n))}),t.nrm(10,"i",56),t.k0s()()()}if(2&r){const e=d.index,o=t.XpG();t.Y8G("formGroupName",e),t.R7$(5),t.Y8G("ngIf",(o.suggestions[e]||t.lJ4(3,I)).length>0),t.R7$(4),t.Y8G("disabled",o.items.length<=1)}}function N(r,d){1&r&&t.nrm(0,"span",60)}function R(r,d){if(1&r&&(t.j41(0,"div",61)(1,"div")(2,"strong"),t.EFF(3),t.k0s()(),t.j41(4,"div",36),t.EFF(5),t.k0s(),t.j41(6,"div",36),t.EFF(7),t.k0s(),t.nrm(8,"div",62),t.k0s()),2&r){let e,o,n;const i=d.$implicit;t.R7$(3),t.JRh((null==(e=i.get("nombre"))?null:e.value)||"\u2014"),t.R7$(2),t.SpI("",(null==(o=i.get("cantidad"))?null:o.value)||"\u2014"," unidades"),t.R7$(2),t.JRh((null==(n=i.get("dosis"))?null:n.value)||"\u2014")}}function S(r,d){if(1&r&&(t.j41(0,"div",63)(1,"div",64),t.EFF(2,"Otras indicaciones"),t.k0s(),t.j41(3,"div",36),t.EFF(4),t.k0s()()),2&r){let e;const o=t.XpG();t.R7$(4),t.JRh(null==(e=o.form.get("observaciones"))?null:e.value)}}let T=(()=>{class r{fb;auth;toast;meds;patientsSvc;http;form;today=new Date;doctorName="";doctorEmail="";doctorColegiado="";maxItems=15;isGenerating=!1;logoPath="assets/favicon.svg";clinicPhone="4265-8975";clinicAddress="4ta calle 13-47 zona 3, segundo nivel";suggestions={};patients=[];selectedPatient=null;constructor(e,o,n,i,c,a){this.fb=e,this.auth=o,this.toast=n,this.meds=i,this.patientsSvc=c,this.http=a}ngOnInit(){const e=this.auth.currentUserValue;(!e||"doctor"!==String(e.tipo).toLowerCase())&&this.toast.show("Solo los doctores pueden generar recetas","error"),this.doctorName=`${e?.nombres||""} ${e?.apellidos||""}`.trim(),this.doctorEmail=e?.correo||"",this.doctorColegiado=e?.colegiado||"",this.form=this.fb.group({fecha:[this.formatDate(this.today),[s.k0.required]],doctor:[{value:this.doctorName,disabled:!0}],pacienteDPI:["",[s.k0.required]],items:this.fb.array([this.createItem()]),observaciones:[""]}),this.patientsSvc.list(!1).subscribe(o=>{this.patients=o||[]})}get items(){return this.form.get("items")}createItem(){return this.fb.group({cantidad:[null,[s.k0.min(.01),s.k0.required]],nombre:["",[s.k0.required,s.k0.maxLength(255)]],dosis:["",[s.k0.required,s.k0.maxLength(255)]]})}addItem(){this.items.length>=this.maxItems||this.items.push(this.createItem())}removeItem(e){this.items.length<=1||this.items.removeAt(e)}onNameInput(e){const n=(this.items.at(e).get("nombre")?.value||"").toString().trim();n?this.meds.search(n).subscribe({next:i=>{this.suggestions[e]=(i?.data||i||[]).map(c=>c.nombre||c.Nombre||c)},error:i=>{this.suggestions[e]=[]}}):this.suggestions[e]=[]}applySuggestion(e,o){this.items.at(e).get("nombre")?.setValue(o),this.suggestions[e]=[]}canGenerate(){return this.form.valid&&this.items.length>0&&!this.isGenerating}formatDate(e){const o=n=>n.toString().padStart(2,"0");return`${e.getFullYear()}-${o(e.getMonth()+1)}-${o(e.getDate())}`}generatePdf(){var e=this;return(0,x.A)(function*(){if(e.canGenerate()){e.isGenerating=!0;try{const o=new Set;e.items.value.forEach(n=>{const i=(n.nombre||"").toString().trim();i&&o.add(i)});for(const n of o)try{yield e.meds.add(n).toPromise()}catch{}}catch{}try{const o=e.buildPayload();try{yield e.http.post((window.__env?.apiUrl||"/api")+"/recetas",o).toPromise()}catch(U){console.warn("[RECETAS] error al guardar",U),e.toast.show("No se pudo guardar la receta en el servidor","error")}const n=document.getElementById("rx-sheet");if(!n)return e.toast.show("No se encontr\xf3 la plantilla de la receta","error"),void(e.isGenerating=!1);const i=yield M()(n,{scale:2,useCORS:!0,backgroundColor:"#ffffff"}),c=i.toDataURL("image/png"),a=new O.Ay("p","pt","letter"),_=a.internal.pageSize.getWidth(),b=a.internal.pageSize.getHeight(),P=Math.min(_/i.width,b/i.height),v=i.width*P,C=i.height*P;a.addImage(c,"PNG",(_-v)/2,(b-C)/2,v,C,void 0,"FAST"),a.save(`receta_${e.formatDate(new Date)}.pdf`),e.toast.show("PDF generado correctamente")}catch(o){console.error("[PDF] error",o),e.toast.show("No se pudo generar el PDF","error")}finally{e.isGenerating=!1}}else e.toast.show("Completa los campos requeridos","error")})()}buildPayload(){const e=this.items.value.map(n=>({cantidad:Number(n.cantidad),nombre:(n.nombre||"").trim(),dosis:(n.dosis||"").trim()})),o=this.form.get("pacienteDPI")?.value;return{fecha:this.form.get("fecha")?.value,doctor:{nombre:this.doctorName,correo:this.doctorEmail,colegiado:this.doctorColegiado},paciente_dpi:o,observaciones:this.form.get("observaciones")?.value||"",items:e}}getSelectedPatient(){try{const e=this.form.get("pacienteDPI")?.value;return this.patients.find(n=>String(n.DPI)===String(e))||null}catch{return null}}static \u0275fac=function(o){return new(o||r)(t.rXU(s.ok),t.rXU(k.u),t.rXU(y.f),t.rXU(D),t.rXU(j.X),t.rXU(f.Qq))};static \u0275cmp=t.VBU({type:r,selectors:[["app-doctor-prescription"]],decls:88,vars:18,consts:[[1,"container-xxl","py-3"],[1,"toolbar","d-flex","align-items-center","justify-content-between","p-2","mb-3","flex-wrap","gap-2"],[1,"m-0"],[1,"card",3,"formGroup"],[1,"card-body"],[1,"row","g-3","mb-3"],[1,"col-sm-4"],[1,"form-label"],["type","date","formControlName","fecha",1,"form-control"],[1,"col-sm-8"],["type","text","disabled","",1,"form-control",3,"value"],[1,"col-12","col-md-8"],["formControlName","pacienteDPI",1,"form-control"],["value","","disabled",""],[3,"value",4,"ngFor","ngForOf"],[1,"d-flex","align-items-center","justify-content-between","mb-2"],["type","button",1,"btn","btn-outline-primary","btn-sm",3,"click","disabled"],[1,"rx-table"],[1,"col-qty"],[1,"col-name"],[1,"col-dose"],[1,"col-actions"],[1,"small","text-muted"],["formArrayName","items"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"mt-3","obs-container"],[1,"form-label","d-block","mb-1"],["rows","3","formControlName","observaciones","placeholder","Indicaciones adicionales",1,"form-control"],[1,"mt-3","text-end"],["type","button",1,"btn","btn-primary",3,"click","disabled"],["class","spinner-border spinner-border-sm me-1",4,"ngIf"],["id","rx-sheet",1,"rx-sheet","print-template","visually-hidden"],[1,"rx-header","d-flex","align-items-start","justify-content-between"],[1,"d-flex","align-items-center","gap-3"],["alt","logo",1,"rx-logo",3,"src"],[1,"fw-semibold"],[1,"small"],[1,"text-end","small"],[1,"rx-body","mt-3"],["class","rx-item",4,"ngFor","ngForOf"],["class","mt-3",4,"ngIf"],[1,"small","mt-2"],[1,"rx-footer"],[1,"signature"],[1,"small","text-center"],[3,"value"],[3,"formGroupName"],[1,"qty"],["type","number","placeholder","0.00","step","0.01","min","0.01","formControlName","cantidad",1,"form-control"],[1,"name","position-relative"],["type","text","placeholder","Nombre del medicamento","formControlName","nombre","autocomplete","off",1,"form-control",3,"input"],["class","list-group suggestions",4,"ngIf"],[1,"dose"],["type","text","placeholder","Indicaciones / Dosis","formControlName","dosis",1,"form-control"],[1,"actions","text-end"],["type","button","title","Eliminar",1,"btn","btn-outline-danger",3,"click","disabled"],[1,"fas","fa-trash"],[1,"list-group","suggestions"],["class","list-group-item list-group-item-action",3,"click",4,"ngFor","ngForOf"],[1,"list-group-item","list-group-item-action",3,"click"],[1,"spinner-border","spinner-border-sm","me-1"],[1,"rx-item"],[1,"divider"],[1,"mt-3"],[1,"fw-semibold","mb-1"]],template:function(o,n){if(1&o&&(t.j41(0,"div",0)(1,"div",1)(2,"h5",2),t.EFF(3,"Generaci\xf3n de receta"),t.k0s()(),t.j41(4,"form",3)(5,"div",4)(6,"div",5)(7,"div",6)(8,"label",7),t.EFF(9,"Fecha"),t.k0s(),t.nrm(10,"input",8),t.k0s(),t.j41(11,"div",9)(12,"label",7),t.EFF(13,"Doctor"),t.k0s(),t.nrm(14,"input",10),t.k0s()(),t.j41(15,"div",5)(16,"div",11)(17,"label",7),t.EFF(18,"Paciente"),t.k0s(),t.j41(19,"select",12)(20,"option",13),t.EFF(21,"Seleccione un paciente"),t.k0s(),t.DNE(22,E,2,3,"option",14),t.k0s()()(),t.j41(23,"div",15)(24,"h6",2),t.EFF(25,"Medicamentos"),t.k0s(),t.j41(26,"button",16),t.bIt("click",function(){return n.addItem()}),t.EFF(27,"Agregar \xedtem"),t.k0s()(),t.j41(28,"table",17)(29,"colgroup"),t.nrm(30,"col",18)(31,"col",19)(32,"col",20)(33,"col",21),t.k0s(),t.j41(34,"thead")(35,"tr",22)(36,"th"),t.EFF(37,"Cantidad"),t.k0s(),t.j41(38,"th"),t.EFF(39,"Medicamento"),t.k0s(),t.j41(40,"th"),t.EFF(41,"Dosis"),t.k0s(),t.nrm(42,"th"),t.k0s()(),t.j41(43,"tbody",23),t.DNE(44,$,11,4,"tr",24),t.k0s()(),t.j41(45,"div",25)(46,"label",26),t.EFF(47,"Observaciones adicionales (opcional)"),t.k0s(),t.nrm(48,"textarea",27),t.k0s(),t.j41(49,"div",28)(50,"button",29),t.bIt("click",function(){return n.generatePdf()}),t.DNE(51,N,1,0,"span",30),t.EFF(52," Generar PDF "),t.k0s()()()(),t.j41(53,"div",31)(54,"div",32)(55,"div",33),t.nrm(56,"img",34),t.j41(57,"div")(58,"div",35),t.EFF(59,"Centro Dermatol\xf3gico"),t.k0s(),t.j41(60,"div",36),t.EFF(61),t.k0s(),t.j41(62,"div",36),t.EFF(63),t.k0s(),t.j41(64,"div",36),t.EFF(65),t.k0s()()(),t.j41(66,"div",37)(67,"div")(68,"strong"),t.EFF(69),t.k0s()(),t.j41(70,"div"),t.EFF(71),t.k0s()()(),t.nrm(72,"hr"),t.j41(73,"div",36)(74,"strong"),t.EFF(75,"Paciente"),t.k0s(),t.EFF(76," __________________________________________"),t.k0s(),t.j41(77,"div",38),t.DNE(78,R,9,3,"div",39)(79,S,5,1,"div",40),t.k0s(),t.j41(80,"div",41)(81,"strong"),t.EFF(82,"Paciente:"),t.k0s(),t.EFF(83),t.k0s(),t.j41(84,"div",42),t.nrm(85,"div",43),t.j41(86,"div",44),t.EFF(87),t.k0s()()()()),2&o){let i,c,a;t.R7$(4),t.Y8G("formGroup",n.form),t.R7$(10),t.Y8G("value",n.doctorName),t.R7$(8),t.Y8G("ngForOf",n.patients),t.R7$(4),t.Y8G("disabled",n.items.length>=n.maxItems),t.R7$(18),t.Y8G("ngForOf",n.items.controls),t.R7$(6),t.Y8G("disabled",!n.canGenerate()),t.R7$(),t.Y8G("ngIf",n.isGenerating),t.R7$(5),t.Y8G("src",n.logoPath,t.B4B),t.R7$(5),t.JRh(n.clinicAddress),t.R7$(2),t.SpI("Tel\xe9fono: ",n.clinicPhone),t.R7$(2),t.SpI("Correo: ",n.doctorEmail),t.R7$(4),t.SpI("Dr(a). ",n.doctorName),t.R7$(2),t.SpI("Fecha: ",null==(i=n.form.get("fecha"))?null:i.value),t.R7$(7),t.Y8G("ngForOf",n.items.controls),t.R7$(),t.Y8G("ngIf",null==(c=n.form.get("observaciones"))?null:c.value),t.R7$(4),t.Lme(" ",((null==(a=n.getSelectedPatient())?null:a.Nombres)||(null==(a=n.getSelectedPatient())?null:a.nombres)||"")+" "+((null==(a=n.getSelectedPatient())?null:a.Apellidos)||(null==(a=n.getSelectedPatient())?null:a.apellidos)||"")," \u2014 DPI: ",(null==(a=n.form.get("pacienteDPI"))?null:a.value)||"\u2014"),t.R7$(4),t.SpI("Firma Dr(a). ",n.doctorName)}},dependencies:[g.MD,g.Sq,g.bT,s.YN,s.qT,s.xH,s.y7,s.me,s.Q0,s.wz,s.BC,s.cb,s.VZ,s.X1,s.j4,s.JD,s.$R,s.v8],styles:['.rx-table[_ngcontent-%COMP%]{width:100%;max-width:100%;table-layout:fixed;border-collapse:collapse;border-spacing:0}.rx-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;font-weight:500;padding:0 4px}.rx-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:0 4px;vertical-align:bottom}.rx-table[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{width:100%;height:38px}.rx-table[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%]{text-align:right}.rx-table[_ngcontent-%COMP%]   col.col-qty[_ngcontent-%COMP%]{width:88px}.rx-table[_ngcontent-%COMP%]   col.col-name[_ngcontent-%COMP%]{width:28%}.rx-table[_ngcontent-%COMP%]   col.col-dose[_ngcontent-%COMP%]{width:calc(100% - (128px + 28%))}.rx-table[_ngcontent-%COMP%]   col.col-actions[_ngcontent-%COMP%]{width:44px}.rx-table[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]{white-space:nowrap}@media (max-width: 768px){.rx-table[_ngcontent-%COMP%], .rx-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%], .rx-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%], .rx-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%], .rx-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .rx-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:block}.rx-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.rx-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{border:1px solid var(--border-color, #e5e7eb);border-radius:8px;padding:8px;margin-bottom:10px}.rx-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:6px 0}.rx-table[_ngcontent-%COMP%]   td.actions[_ngcontent-%COMP%]{text-align:right}}.obs-container[_ngcontent-%COMP%], .obs-container[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{width:100%}.rx-sheet[_ngcontent-%COMP%]{background:#fff;color:#222;border:1px solid var(--border-color, #e5e7eb);border-radius:8px;padding:24px;position:relative;overflow:hidden}.rx-header[_ngcontent-%COMP%]   .rx-logo[_ngcontent-%COMP%]{width:56px;height:56px}.rx-body[_ngcontent-%COMP%]   .divider[_ngcontent-%COMP%]{height:10px;border-bottom:1px dashed #d0d5dd;margin:4px 0 10px}.rx-watermark[_ngcontent-%COMP%]{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:96px;color:#0000000d;pointer-events:none;-webkit-user-select:none;user-select:none}.rx-footer[_ngcontent-%COMP%]{margin-top:60px}.rx-footer[_ngcontent-%COMP%]   .signature[_ngcontent-%COMP%]{height:48px;border-bottom:2px solid #111827;margin:0 64px 6px}.suggestions[_ngcontent-%COMP%]{position:absolute;z-index:1000;width:100%;max-height:200px;overflow:auto;left:0;top:100%;margin-top:2px}[data-theme="dark"][_nghost-%COMP%]   .rx-sheet[_ngcontent-%COMP%], [data-theme="dark"]   [_nghost-%COMP%]   .rx-sheet[_ngcontent-%COMP%]{background:#0f172a;color:#e2e8f0;border-color:#1f2937}[data-theme="dark"][_nghost-%COMP%]   .rx-body[_ngcontent-%COMP%]   .divider[_ngcontent-%COMP%], [data-theme="dark"]   [_nghost-%COMP%]   .rx-body[_ngcontent-%COMP%]   .divider[_ngcontent-%COMP%]{border-bottom-color:#334155}[data-theme="dark"][_nghost-%COMP%]   .rx-footer[_ngcontent-%COMP%]   .signature[_ngcontent-%COMP%], [data-theme="dark"]   [_nghost-%COMP%]   .rx-footer[_ngcontent-%COMP%]   .signature[_ngcontent-%COMP%]{border-bottom-color:#e2e8f0}.rx-items[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{height:38px}.rx-items[_ngcontent-%COMP%]   input[type=number][_ngcontent-%COMP%]{text-align:right}.rx-items[_ngcontent-%COMP%]{display:block}.visually-hidden[_ngcontent-%COMP%]{position:absolute!important;left:-9999px!important;top:0!important;width:800px;max-width:1000px}.print-template[_ngcontent-%COMP%]{background:#fff}']})}return r})()}}]);