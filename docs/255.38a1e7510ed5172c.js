"use strict";(self.webpackChunkdermatologia_app=self.webpackChunkdermatologia_app||[]).push([[255],{2255:(U,C,l)=>{l.r(C),l.d(C,{DoctorDashboardComponent:()=>R});var b=l(2200),D=l(9417),M=l(8132),f=l(2615),o=l(3664),I=l(4796),O=l(547),E=l(8397),k=l(5114),S=l(9330);function F(c,v){if(1&c){const t=o.RV6();o.j41(0,"ul",24)(1,"li")(2,"button",25),o.bIt("click",function(){f.eBV(t);const n=o.XpG();return n.loadTodayAppointments(),f.Njj(n.closeMenu())}),o.EFF(3,"Refrescar"),o.k0s()(),o.j41(4,"li")(5,"button",25),o.bIt("click",function(){f.eBV(t);const n=o.XpG();return n.toggleClockFormat(),f.Njj(n.closeMenu())}),o.EFF(6),o.k0s()()()}if(2&c){const t=o.XpG();o.R7$(6),o.SpI("Formato ",t.use24Hour?"12h":"24h")}}function w(c,v){1&c&&(o.j41(0,"div"),o.EFF(1,"Cargando..."),o.k0s())}function x(c,v){1&c&&(o.j41(0,"div",26),o.EFF(1,"No hay citas hoy."),o.k0s())}let R=(()=>{class c{auth;appointmentService;toast;router;http;el;timeString="";dateString="";use24Hour=!0;menuOpen=!1;_clockInterval=null;_refreshInterval=null;missionText="";visionText="";doctorId=null;appointments=[];loading=!1;constructor(t,e,n,r,d,s){this.auth=t,this.appointmentService=e,this.toast=n,this.router=r,this.http=d,this.el=s}ngOnInit(){this.loadClockPreference(),this.startClock(),this.loadUser(),this._refreshInterval=setInterval(()=>{this.loadTodayAppointments()},15e3),this.loadMissionVision()}loadMissionVision(){try{this.http.get("/api/settings/mission").subscribe({next:t=>{this.missionText=t&&t.value?t.value:""},error:t=>{console.error("Error loading mission for doctor dashboard",t),this.missionText=""}})}catch(t){console.warn(t)}try{this.http.get("/api/settings/vision").subscribe({next:t=>{this.visionText=t&&t.value?t.value:""},error:t=>{console.error("Error loading vision for doctor dashboard",t),this.visionText=""}})}catch(t){console.warn(t)}}ngOnDestroy(){this._clockInterval&&clearInterval(this._clockInterval),this._refreshInterval&&clearInterval(this._refreshInterval)}startClock(){const t=()=>{const e=new Date;this.timeString=e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!this.use24Hour}),this.dateString=e.toLocaleDateString([],{weekday:"long",year:"numeric",month:"long",day:"numeric"})};t(),this._clockInterval=setInterval(t,1e3)}clockPrefKey(){return"clockFormat:doctor"}loadClockPreference(){try{const t=localStorage.getItem(this.clockPrefKey());this.use24Hour="12"!==t}catch{}}saveClockPreference(){try{localStorage.setItem(this.clockPrefKey(),this.use24Hour?"24":"12")}catch{}}toggleClockFormat(){this.use24Hour=!this.use24Hour,this.saveClockPreference(),this._clockInterval&&(clearInterval(this._clockInterval),this._clockInterval=null),this.startClock()}toggleMenu(){this.menuOpen=!this.menuOpen}closeMenu(){this.menuOpen=!1}onDocClick(t){this.el.nativeElement.contains(t.target)||(this.menuOpen=!1)}loadUser(){const t=this.auth.currentUserValue;t&&(this.doctorId=t?.id||t?.userId||t?._id||t?.doctorId||t?.usuarioId&&t.usuarioId.id||null,!this.doctorId&&t?.dpi&&(this.doctorId=t.dpi),this.loadTodayAppointments())}formatDateIso(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}loadTodayAppointments(){this.loading=!0,console.log("[DoctorDashboard] loadTodayAppointments doctorId=",this.doctorId);const t=new Date,n=(this.formatDateIso(t),r=>{const d=Array.isArray(r)?r:r.citas||r.data||r;this.appointments=(d||[]).filter(s=>this.isSameDate(s.Fecha||s.fecha||s.date||"",t)).sort((s,m)=>(s.hora||s.Hora||s.time||"").localeCompare(m.hora||m.Hora||m.time||""))});this.doctorId?this.appointmentService.getCitasPorDoctor(this.doctorId).subscribe({next:r=>{if(console.log("[DoctorDashboard] getCitasPorDoctor resp=",r),n(r),this.appointments&&0!==this.appointments.length)this.loading=!1;else{console.log("[DoctorDashboard] no citas from getCitasPorDoctor, trying paged fallback by email/name");const d=this.auth.currentUserValue,s=this.getUserEmailCandidates(d),m=this.getUserNameCandidates(d);this.appointmentService.getCitasPaged(1,500).subscribe({next:a=>{console.log("[DoctorDashboard] fallback getCitasPaged resp length=",a&&a.data&&a.data.length||(Array.isArray(a)?a.length:0));const _=((Array.isArray(a)?a:a.data||a.citas||a)||[]).filter(i=>{if(!this.isSameDate(i.Fecha||i.fecha||i.date||"",t))return!1;const p=String(i.Profesional_Responsable||i.profesional_Responsable||i.profesional||i.profesionalId||"").toLowerCase(),T=String(i.profesionalEmail||i.doctorEmail||i.email||"").toLowerCase();if(s.some(g=>g&&p.includes(String(g).toLowerCase()))||s.some(g=>g&&T.includes(String(g).toLowerCase())))return!0;const A=String(i.doctorNombres||i.doctorNombre||i.doctorName||i.nombreProfesional||i.ProfesionalNombre||"").toLowerCase();if(m.some(g=>g&&A.includes(String(g).toLowerCase())))return!0;const P=String(i.Colegiado||i.colegiado||i.colegiadoId||i.colegiado_numero||"").toLowerCase(),y=d&&(d.colegiado||d.Colegiado||d.colegiadoNum||d.colegiado_numero)?String(d.colegiado||d.Colegiado||d.colegiadoNum||d.colegiado_numero).toLowerCase():null;return!(!y||!P||y!==P)});this.appointments=_.sort((i,p)=>(i.hora||i.Hora||i.time||"").localeCompare(p.hora||p.Hora||p.time||"")),console.log("[DoctorDashboard] fallback filtered appointments length=",this.appointments.length),this.loading=!1},error:a=>{console.error(a),this.toast.show("Error buscando citas en fallback"),this.loading=!1}})}},error:r=>{console.error(r),this.toast.show("Error cargando citas por doctor"),this.loading=!1}}):this.appointmentService.getCitasPaged(1,500).subscribe({next:r=>{console.log("[DoctorDashboard] getCitasPaged resp length=",r&&r.data&&r.data.length||(Array.isArray(r)?r.length:0));const d=this.getUserIdCandidates(this.auth.currentUserValue);console.log("[DoctorDashboard] user id candidates=",d);const m=((Array.isArray(r)?r:r.data||r.citas||r)||[]).filter(a=>{const u=a.Profesional_Responsable||a.profesional_Responsable||a.Profesional||a.profesional||a.profesionalResponsable||a.profesional_responsable||a.profesionalId||a.profesional;return d.some(_=>null!==_&&String(_)===String(u))&&this.isSameDate(a.Fecha||a.fecha||a.date||"",t)});this.appointments=m.sort((a,u)=>(a.hora||a.Hora||a.time||"").localeCompare(u.hora||u.Hora||u.time||"")),this.loading=!1},error:r=>{console.error(r),this.toast.show("Error cargando citas"),this.loading=!1}})}isSameDate(t,e){if(!t)return!1;try{const n=new Date(t);return n.getFullYear()===e.getFullYear()&&n.getMonth()===e.getMonth()&&n.getDate()===e.getDate()}catch{return!1}}getUserIdCandidates(t){if(!t)return[null];const e=[];return t.id&&e.push(t.id),t.dpi&&e.push(t.dpi),t.Profesional_Responsable&&e.push(t.Profesional_Responsable),t.profesional_Responsable&&e.push(t.profesional_Responsable),t.usuarioId&&t.usuarioId.id&&e.push(t.usuarioId.id),t.userId&&e.push(t.userId),Array.from(new Set(e.filter(n=>null!=n)))}getUserEmailCandidates(t){if(!t)return[];const e=[];return t.email&&e.push(String(t.email)),t.correo&&e.push(String(t.correo)),t.usuario&&t.usuario.email&&e.push(String(t.usuario.email)),Array.from(new Set(e.filter(n=>!!n)))}getUserNameCandidates(t){if(!t)return[];const e=[];return t.nombre&&e.push(String(t.nombre)),t.nombres&&e.push(String(t.nombres)),t.fullName&&e.push(String(t.fullName)),t.usuario&&(t.usuario.nombre||t.usuario.nombres)&&e.push(String(t.usuario.nombre||t.usuario.nombres)),Array.from(new Set(e.filter(n=>!!n)))}displayPatientName(t){return t?((t.pacienteNombres||t.pacienteNombre||t.pacienteInfo&&t.pacienteInfo.nombres||t.Paciente||t.paciente||"")+" "+(t.pacienteApellidos||t.pacienteInfo&&t.pacienteInfo.apellidos||"")).trim():""}displayTime(t){const e=t.hora||t.Hora||t.time||"";return e?e.slice(0,5):""}displayDate(t){if(!t)return"";const e=t.fecha||t.Fecha||t.date;if(!e)return"";const n=new Date(e);return isNaN(n.getTime())?e:n.toLocaleDateString()}getProfesionalResponsable(t){return t.Profesional_Responsable||t.profesional_Responsable||t.profesional||t.profesionalId||t.profesionalResponsable}static \u0275fac=function(e){return new(e||c)(o.rXU(I.u),o.rXU(O.h),o.rXU(E.f),o.rXU(k.Ix),o.rXU(S.Qq),o.rXU(o.aKT))};static \u0275cmp=o.VBU({type:c,selectors:[["app-doctor-dashboard"]],hostBindings:function(e,n){1&e&&o.bIt("click",function(d){return n.onDocClick(d)},o.EBC)},decls:42,vars:9,consts:[[1,"doctor-dashboard","container","py-3"],[1,"toolbar","d-flex","align-items-center","gap-2","p-2","mb-3","flex-wrap"],[1,"flex-grow-1"],[1,"position-relative"],["type","button","aria-haspopup","true",1,"btn","btn-outline-secondary",3,"click"],[1,"fas","fa-ellipsis-v"],["class","dropdown-menu dropdown-menu-end show","style","display:block; position:absolute; right:0; top:100%;",4,"ngIf"],[1,"hero","d-flex","justify-content-center","mb-3"],[1,"clock-large","text-center"],[1,"time"],[1,"date","small","text-muted"],[4,"ngIf"],["class","text-muted",4,"ngIf"],[1,"appointments-summary","mt-4","d-flex","justify-content-center"],[1,"card","summary-card","p-4","text-center"],[1,"summary-title","mb-2"],[1,"summary-count","display-1","mb-2"],[1,"summary-sub","small","text-muted"],[1,"mission-vision","row","g-3","mt-4"],[1,"col-md-6","mb-3"],[1,"card","p-3"],[1,"card-header","pb-2"],[1,"card-body","pt-1"],[1,"mb-0"],[1,"dropdown-menu","dropdown-menu-end","show",2,"display","block","position","absolute","right","0","top","100%"],["type","button",1,"dropdown-item",3,"click"],[1,"text-muted"]],template:function(e,n){1&e&&(o.j41(0,"div",0)(1,"div",1),o.nrm(2,"div",2),o.j41(3,"div",3)(4,"button",4),o.bIt("click",function(){return n.toggleMenu()}),o.nrm(5,"i",5),o.k0s(),o.DNE(6,F,7,1,"ul",6),o.k0s()(),o.j41(7,"div",7)(8,"div",8)(9,"div",9),o.EFF(10),o.k0s(),o.j41(11,"div",10),o.EFF(12),o.k0s()()(),o.j41(13,"h4"),o.EFF(14,"Agenda de Hoy"),o.k0s(),o.DNE(15,w,2,0,"div",11)(16,x,2,0,"div",12),o.j41(17,"div",13)(18,"div",14)(19,"div",15),o.EFF(20,"Citas programadas hoy"),o.k0s(),o.j41(21,"div",16),o.EFF(22),o.k0s(),o.j41(23,"div",17),o.EFF(24,"(Total de citas para la fecha de hoy)"),o.k0s()()(),o.j41(25,"div",18)(26,"div",19)(27,"div",20)(28,"div",21)(29,"strong"),o.EFF(30,"Misi\xf3n"),o.k0s()(),o.j41(31,"div",22)(32,"p",23),o.EFF(33),o.k0s()()()(),o.j41(34,"div",19)(35,"div",20)(36,"div",21)(37,"strong"),o.EFF(38,"Visi\xf3n"),o.k0s()(),o.j41(39,"div",22)(40,"p",23),o.EFF(41),o.k0s()()()()()()),2&e&&(o.R7$(4),o.BMQ("aria-expanded",n.menuOpen),o.R7$(2),o.Y8G("ngIf",n.menuOpen),o.R7$(4),o.JRh(n.timeString),o.R7$(2),o.JRh(n.dateString),o.R7$(3),o.Y8G("ngIf",n.loading),o.R7$(),o.Y8G("ngIf",!n.loading&&0===n.appointments.length),o.R7$(6),o.JRh(n.appointments.length),o.R7$(11),o.JRh(n.missionText||"No definida"),o.R7$(8),o.JRh(n.visionText||"No definida"))},dependencies:[b.MD,b.bT,D.YN,M.iI],styles:[".doctor-dashboard[_ngcontent-%COMP%]   .clock-large[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{font-size:3.6rem;font-weight:800;color:var(--text-dark)}.doctor-dashboard[_ngcontent-%COMP%]   .date[_ngcontent-%COMP%]{font-size:1.05rem;font-weight:600;color:var(--text-light)}.apt-card[_ngcontent-%COMP%]{box-shadow:var(--shadow-1);border:1px solid var(--border-color);background:var(--surface-1);border-radius:10px}.apt-card[_ngcontent-%COMP%]   .actions[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{padding:.45rem .7rem}@media (max-width: 576px){.apt-card[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.5rem}.apt-card[_ngcontent-%COMP%]   .actions[_ngcontent-%COMP%]{width:100%;justify-content:space-between}}.summary-card[_ngcontent-%COMP%]{max-width:420px;width:100%;border-radius:var(--radius-md);box-shadow:var(--shadow-1);border:1px solid var(--border-color);background:var(--surface-1)}.summary-card[_ngcontent-%COMP%]   .summary-title[_ngcontent-%COMP%]{font-weight:600;font-size:1.05rem;letter-spacing:.2px;color:var(--text-dark)}.summary-card[_ngcontent-%COMP%]   .summary-count[_ngcontent-%COMP%]{font-weight:800;font-size:3.25rem;color:var(--primary-green)}.summary-card[_ngcontent-%COMP%]   .summary-sub[_ngcontent-%COMP%]{margin-top:6px;color:var(--text-light)}.doctor-dashboard[_ngcontent-%COMP%]   .hero[_ngcontent-%COMP%]{margin-bottom:1.5rem}.doctor-dashboard[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin-bottom:1.25rem}.appointments-summary[_ngcontent-%COMP%]{margin-top:.75rem;margin-bottom:1.6rem}.doctor-dashboard[_ngcontent-%COMP%]   .summary-card[_ngcontent-%COMP%]{padding:1.6rem}.mission-vision[_ngcontent-%COMP%]{gap:1.25rem;margin-top:1.4rem}.mission-vision[_ngcontent-%COMP%]   .col-md-6[_ngcontent-%COMP%]{display:flex}.mission-vision[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{width:100%;padding:1rem;margin-bottom:.8rem;box-shadow:var(--shadow-1);border:1px solid var(--border-color);border-radius:var(--radius-md);background:var(--surface-1)}.mission-vision[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding-top:.5rem}.mission-vision[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%] + .card[_ngcontent-%COMP%]{margin-top:.5rem}@media (max-width: 576px){.summary-card[_ngcontent-%COMP%]   .summary-count[_ngcontent-%COMP%]{font-size:2.2rem}.summary-card[_ngcontent-%COMP%]{padding:1rem}}"]})}return c})()}}]);