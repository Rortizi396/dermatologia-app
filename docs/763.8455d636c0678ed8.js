"use strict";(self.webpackChunkdermatologia_app=self.webpackChunkdermatologia_app||[]).push([[763],{9763:(v,p,d)=>{d.d(p,{N:()=>F});var c=d(2200),s=d(9417),u=d(2615),e=d(3664),g=d(9330);function _(a,l){if(1&a&&(e.j41(0,"tr")(1,"td",24),e.EFF(2),e.k0s(),e.j41(3,"td")(4,"span"),e.EFF(5),e.k0s()(),e.j41(6,"td")(7,"small",25),e.EFF(8),e.k0s(),e.j41(9,"div",26)(10,"strong"),e.EFF(11),e.k0s()()(),e.j41(12,"td")(13,"div",27)(14,"pre",28),e.EFF(15),e.k0s()()(),e.j41(16,"td")(17,"div",27)(18,"pre",28),e.EFF(19),e.k0s()()(),e.j41(20,"td")(21,"div",29),e.EFF(22),e.k0s()(),e.j41(23,"td"),e.EFF(24),e.nI1(25,"date"),e.k0s()()),2&a){const n=l.$implicit,t=e.XpG(2);e.R7$(2),e.JRh(n.id),e.R7$(2),e.HbH(e.VkB("badge event-badge ",t.getEventBadgeClass(n))),e.R7$(),e.JRh(t.getEventLabel(n)),e.R7$(3),e.JRh(n.resource_type),e.R7$(3),e.SpI("#",n.resource_id),e.R7$(4),e.JRh(n.old_preview||"-"),e.R7$(4),e.JRh(n.new_preview||"-"),e.R7$(2),e.Y8G("title",e.mNQ(n.changed_by)),e.R7$(),e.JRh(n.changed_by||"anonymous"),e.R7$(2),e.JRh(e.i5U(25,13,n.created_at,"short"))}}function f(a,l){if(1&a&&(e.j41(0,"div",18)(1,"table",19)(2,"thead")(3,"tr")(4,"th",20),e.EFF(5,"ID"),e.k0s(),e.j41(6,"th",21),e.EFF(7,"Evento"),e.k0s(),e.j41(8,"th",21),e.EFF(9,"Recurso"),e.k0s(),e.j41(10,"th"),e.EFF(11,"Old"),e.k0s(),e.j41(12,"th"),e.EFF(13,"New"),e.k0s(),e.j41(14,"th",22),e.EFF(15,"Usuario"),e.k0s(),e.j41(16,"th",21),e.EFF(17,"Fecha"),e.k0s()()(),e.j41(18,"tbody"),e.DNE(19,_,26,16,"tr",23),e.k0s()()()),2&a){const n=e.XpG();e.R7$(19),e.Y8G("ngForOf",n.records)}}function m(a,l){1&a&&(e.j41(0,"span"),e.EFF(1,"Deshacer"),e.k0s())}function h(a,l){1&a&&(e.j41(0,"span"),e.EFF(1,"Deshaciendo..."),e.k0s())}function b(a,l){if(1&a){const n=e.RV6();e.j41(0,"tr")(1,"td",24),e.EFF(2),e.k0s(),e.j41(3,"td")(4,"span"),e.EFF(5),e.k0s()(),e.j41(6,"td")(7,"small",25),e.EFF(8),e.k0s(),e.j41(9,"div",26)(10,"strong"),e.EFF(11),e.k0s()()(),e.j41(12,"td")(13,"div",27)(14,"pre",28),e.EFF(15),e.k0s()()(),e.j41(16,"td")(17,"div",27)(18,"pre",28),e.EFF(19),e.k0s()()(),e.j41(20,"td")(21,"div",29),e.EFF(22),e.k0s()(),e.j41(23,"td"),e.EFF(24),e.nI1(25,"date"),e.k0s(),e.j41(26,"td")(27,"div",31)(28,"button",32),e.bIt("click",function(){const i=u.eBV(n).$implicit,r=e.XpG(2);return u.Njj(r.undo(i.id))}),e.DNE(29,m,2,0,"span",33)(30,h,2,0,"span",33),e.k0s()()()()}if(2&a){const n=l.$implicit,t=e.XpG(2);e.R7$(2),e.JRh(n.id),e.R7$(2),e.HbH(e.VkB("badge event-badge ",t.getEventBadgeClass(n))),e.R7$(),e.JRh(t.getEventLabel(n)),e.R7$(3),e.JRh(n.resource_type),e.R7$(3),e.SpI("#",n.resource_id),e.R7$(4),e.JRh(n.old_preview||"-"),e.R7$(4),e.JRh(n.new_preview||"-"),e.R7$(2),e.Y8G("title",e.mNQ(n.changed_by)),e.R7$(),e.JRh(n.changed_by||"anonymous"),e.R7$(2),e.JRh(e.i5U(25,16,n.created_at,"short")),e.R7$(4),e.Y8G("disabled",t.undoing[n.id]),e.R7$(),e.Y8G("ngIf",!t.undoing[n.id]),e.R7$(),e.Y8G("ngIf",t.undoing[n.id])}}function C(a,l){if(1&a&&(e.j41(0,"div",18)(1,"table",19)(2,"thead")(3,"tr")(4,"th",20),e.EFF(5,"ID"),e.k0s(),e.j41(6,"th",21),e.EFF(7,"Evento"),e.k0s(),e.j41(8,"th",21),e.EFF(9,"Recurso"),e.k0s(),e.j41(10,"th"),e.EFF(11,"Old"),e.k0s(),e.j41(12,"th"),e.EFF(13,"New"),e.k0s(),e.j41(14,"th",22),e.EFF(15,"Usuario"),e.k0s(),e.j41(16,"th",21),e.EFF(17,"Fecha"),e.k0s(),e.j41(18,"th",30),e.EFF(19,"Acciones"),e.k0s()()(),e.j41(20,"tbody"),e.DNE(21,b,31,19,"tr",23),e.k0s()()()),2&a){const n=e.XpG();e.R7$(21),e.Y8G("ngForOf",n.records)}}let F=(()=>{class a{http;records=[];activeTab="appointments";undoing={};apiBase=window.__env&&window.__env.apiUrl?window.__env.apiUrl:"/api";filterEvent=null;filterResourceId=null;filterChangedBy=null;filterSince=null;filterUntil=null;filterLimit=200;constructor(n){this.http=n}ngOnInit(){this.load()}setTab(n){this.activeTab=n,this.load()}load(){const t=[];t.push("resource="+("users"===this.activeTab?"user":"appointment")),this.filterEvent&&t.push(`event=${encodeURIComponent(this.filterEvent)}`),this.filterResourceId&&t.push(`resource_id=${encodeURIComponent(this.filterResourceId)}`),this.filterChangedBy&&t.push(`user=${encodeURIComponent(this.filterChangedBy)}`),this.filterSince&&t.push(`since=${encodeURIComponent(this.filterSince)}`),this.filterUntil&&t.push(`until=${encodeURIComponent(this.filterUntil)}`),t.push(`limit=${encodeURIComponent(String(this.filterLimit||200))}`),t.push(`_=${Date.now()}`);const i=`${this.apiBase}/audit?${t.join("&")}`;this.http.get(i,{headers:{Accept:"application/json"}}).subscribe({next:r=>{r&&r.success&&(this.records=r.data||[])},error:r=>{console.error("Error loading audit",r)}})}applyFilters(){this.load()}clearFilters(){this.filterEvent=null,this.filterResourceId=null,this.filterChangedBy=null,this.filterSince=null,this.filterUntil=null,this.filterLimit=200,this.load()}getEventLabel(n){const t=String(n.event_type||"").toLowerCase();if("user"===(n.resource_type||"").toLowerCase()||"users"===this.activeTab)return t.includes("create")||t.includes("user_create")?"Creaci\xf3n usuario":t.includes("update")||t.includes("edit")||t.includes("user_update")?"Edici\xf3n usuario":t.includes("delete")||t.includes("inactivate")?"Eliminaci\xf3n usuario":t;const i=t.replace(/^appointment_?/,"");return i.includes("create")?"Creaci\xf3n cita":i.includes("confirm")?"Confirmaci\xf3n cita":i.includes("cancel")?"Cancelaci\xf3n cita":i.includes("undo")?"Deshacer cita":i||t}getEventBadgeClass(n){const t=this.getEventLabel(n).toLowerCase();return t.includes("confirm")?"confirm":t.includes("cancel")?"cancel":t.includes("creaci\xf3n")||t.includes("creacion")||t.includes("create")?"create":t.includes("edici")||t.includes("edit")?"edit":"create"}undo(n){confirm("\xbfSeguro que quieres deshacer este cambio de cita?")&&(this.undoing[n]=!0,this.http.post(`${this.apiBase}/audit/${n}/undo`,{},{headers:{Accept:"application/json"}}).subscribe({next:t=>{this.undoing[n]=!1,this.load(),alert(t&&t.message?t.message:"Deshecho")},error:t=>{console.error("Undo failed",t);const i=t&&t.status?t.status:0;404===i||0===i?(console.warn("Retrying undo directly against configured backend",this.apiBase),this.http.post(`${this.apiBase}/audit/${n}/undo`,{},{headers:{Accept:"application/json"}}).subscribe({next:r=>{this.undoing[n]=!1,this.load(),alert(r&&r.message?r.message:"Deshecho (directo)")},error:r=>{this.undoing[n]=!1,console.error("Direct undo failed",r),alert("Error al deshacer (directo): "+(r?.error?.message||r.message||r))}})):(this.undoing[n]=!1,alert("Error al deshacer: "+(t?.error?.message||t.message||t)))}}))}static \u0275fac=function(t){return new(t||a)(e.rXU(g.Qq))};static \u0275cmp=e.VBU({type:a,selectors:[["app-audit-history"]],decls:41,vars:16,consts:[[1,"audit-history","card","p-3"],["role","tablist","aria-label","Tipo de historial",1,"tabs","mb-3"],["type","button",1,"tab-btn",3,"click","aria-pressed"],[1,"filters","mb-3"],[1,"filter-row"],[1,"filter-item"],[1,"filter-label"],["placeholder","p.ej. appointment_cancel",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["placeholder","ID",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["placeholder","email",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["type","date",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"filter-item",2,"min-width","90px"],["type","number","min","1","max","1000",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"filter-actions"],[1,"btn","btn-sm","btn-primary",3,"click"],[1,"btn","btn-sm","btn-secondary",3,"click"],["title","Actualizar la tabla con los \xfaltimos eventos",1,"btn","btn-sm","btn-success",3,"click"],["class","audit-table-wrap",4,"ngIf"],[1,"audit-table-wrap"],[1,"table","table-sm","audit-table"],[2,"width","56px"],[2,"width","140px"],[2,"width","120px"],[4,"ngFor","ngForOf"],[1,"cell-id"],[1,"text-muted"],[1,"text-nowrap"],[1,"cell-preview"],[1,"m-0","small"],[1,"text-truncate",3,"title"],[2,"width","110px"],[1,"d-flex"],[1,"btn","btn-sm","btn-outline-primary","me-1",3,"click","disabled"],[4,"ngIf"]],template:function(t,i){1&t&&(e.j41(0,"div",0)(1,"div",1)(2,"button",2),e.bIt("click",function(){return i.setTab("users")}),e.EFF(3,"Usuarios"),e.k0s(),e.j41(4,"button",2),e.bIt("click",function(){return i.setTab("appointments")}),e.EFF(5,"Citas"),e.k0s()(),e.j41(6,"div",3)(7,"div",4)(8,"div",5)(9,"label",6),e.EFF(10,"Evento"),e.k0s(),e.j41(11,"input",7),e.mxI("ngModelChange",function(o){return e.DH7(i.filterEvent,o)||(i.filterEvent=o),o}),e.k0s()(),e.j41(12,"div",5)(13,"label",6),e.EFF(14,"Resource ID"),e.k0s(),e.j41(15,"input",8),e.mxI("ngModelChange",function(o){return e.DH7(i.filterResourceId,o)||(i.filterResourceId=o),o}),e.k0s()(),e.j41(16,"div",5)(17,"label",6),e.EFF(18,"Cambiado por"),e.k0s(),e.j41(19,"input",9),e.mxI("ngModelChange",function(o){return e.DH7(i.filterChangedBy,o)||(i.filterChangedBy=o),o}),e.k0s()(),e.j41(20,"div",5)(21,"label",6),e.EFF(22,"Desde"),e.k0s(),e.j41(23,"input",10),e.mxI("ngModelChange",function(o){return e.DH7(i.filterSince,o)||(i.filterSince=o),o}),e.k0s()(),e.j41(24,"div",5)(25,"label",6),e.EFF(26,"Hasta"),e.k0s(),e.j41(27,"input",10),e.mxI("ngModelChange",function(o){return e.DH7(i.filterUntil,o)||(i.filterUntil=o),o}),e.k0s()(),e.j41(28,"div",11)(29,"label",6),e.EFF(30,"L\xedmite"),e.k0s(),e.j41(31,"input",12),e.mxI("ngModelChange",function(o){return e.DH7(i.filterLimit,o)||(i.filterLimit=o),o}),e.k0s()(),e.j41(32,"div",13)(33,"button",14),e.bIt("click",function(){return i.applyFilters()}),e.EFF(34,"Aplicar"),e.k0s(),e.j41(35,"button",15),e.bIt("click",function(){return i.clearFilters()}),e.EFF(36,"Limpiar"),e.k0s(),e.j41(37,"button",16),e.bIt("click",function(){return i.load()}),e.EFF(38,"Actualizar"),e.k0s()()()(),e.DNE(39,f,20,1,"div",17)(40,C,22,1,"div",17),e.k0s()),2&t&&(e.R7$(2),e.AVh("active","users"===i.activeTab),e.jOp("aria-pressed",e.mNQ("users"===i.activeTab)),e.R7$(2),e.AVh("active","appointments"===i.activeTab),e.jOp("aria-pressed",e.mNQ("appointments"===i.activeTab)),e.R7$(7),e.R50("ngModel",i.filterEvent),e.R7$(4),e.R50("ngModel",i.filterResourceId),e.R7$(4),e.R50("ngModel",i.filterChangedBy),e.R7$(4),e.R50("ngModel",i.filterSince),e.R7$(4),e.R50("ngModel",i.filterUntil),e.R7$(4),e.R50("ngModel",i.filterLimit),e.R7$(8),e.Y8G("ngIf","users"===i.activeTab),e.R7$(),e.Y8G("ngIf","appointments"===i.activeTab))},dependencies:[c.MD,c.Sq,c.bT,s.YN,s.me,s.Q0,s.BC,s.VZ,s.zX,s.vS,c.vh],styles:[".audit-history[_ngcontent-%COMP%]{background:#fff;border-radius:6px}.audit-table[_ngcontent-%COMP%]{table-layout:fixed;width:100%}.audit-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:top;padding:.5rem}.audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell-preview[_ngcontent-%COMP%]{max-height:6.5em;overflow:auto;background:#f8f9fa;border-radius:4px;padding:.35rem}.audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell-preview[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{white-space:pre-wrap;word-break:break-word;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Roboto Mono,Courier New,monospace;font-size:.8rem}.text-truncate[_ngcontent-%COMP%]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}@media (max-width: 768px){.audit-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.audit-table[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:block;width:100%}.audit-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{margin-bottom:.75rem;border-bottom:1px solid #e9ecef}.audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{text-align:left;padding-left:0}.cell-id[_ngcontent-%COMP%]{font-weight:600}}.filter-label[_ngcontent-%COMP%]{display:block;font-size:.78rem;color:var(--text-light);margin-bottom:.35rem}.audit-history[_ngcontent-%COMP%]{border:1px solid var(--gris-medio)}.event-badge[_ngcontent-%COMP%]{padding:.35rem .6rem;border-radius:999px;font-weight:600;font-size:.82rem}.event-badge.confirm[_ngcontent-%COMP%]{background:linear-gradient(90deg,var(--light-green),var(--primary-green));color:#fff}.event-badge.cancel[_ngcontent-%COMP%]{background:linear-gradient(90deg,#ffb3b3,var(--danger));color:#fff}.event-badge.create[_ngcontent-%COMP%]{background:linear-gradient(90deg,var(--lighter-green),var(--light-green));color:#fff}.event-badge.edit[_ngcontent-%COMP%]{background:linear-gradient(90deg,#f0f0f0,#dfe6e0);color:var(--text-dark)}.tabs[_ngcontent-%COMP%]{display:flex;gap:.5rem}.tab-btn[_ngcontent-%COMP%]{background:transparent;border:1px solid transparent;padding:.5rem .9rem;border-radius:8px;cursor:pointer;font-weight:600}.tab-btn.active[_ngcontent-%COMP%]{background:linear-gradient(90deg,var(--lighter-green),var(--light-green));color:#fff;border-color:#0000000d}.filter-row[_ngcontent-%COMP%]{display:flex;gap:.75rem;align-items:flex-end;flex-wrap:wrap}.filter-item[_ngcontent-%COMP%]{min-width:160px;display:flex;flex-direction:column}.filter-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}@media (max-width: 920px){.filter-item[_ngcontent-%COMP%]{min-width:140px}}@media (max-width: 640px){.filter-row[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.filter-actions[_ngcontent-%COMP%]{justify-content:flex-start}}"]})}return a})()}}]);