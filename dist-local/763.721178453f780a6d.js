"use strict";(self.webpackChunkdermatologia_app=self.webpackChunkdermatologia_app||[]).push([[763],{9763:(F,p,d)=>{d.d(p,{N:()=>v});var c=d(2200),l=d(9417),u=d(2615),e=d(3664),g=d(9330);function _(a,s){if(1&a&&(e.j41(0,"tr")(1,"td",30),e.EFF(2),e.k0s(),e.j41(3,"td")(4,"span"),e.EFF(5),e.k0s()(),e.j41(6,"td")(7,"small",31),e.EFF(8),e.k0s(),e.j41(9,"div",32)(10,"strong"),e.EFF(11),e.k0s()()(),e.j41(12,"td")(13,"div",33)(14,"pre",34),e.EFF(15),e.k0s()()(),e.j41(16,"td")(17,"div",33)(18,"pre",34),e.EFF(19),e.k0s()()(),e.j41(20,"td")(21,"div",35),e.EFF(22),e.k0s()(),e.j41(23,"td"),e.EFF(24),e.nI1(25,"date"),e.k0s()()),2&a){const i=s.$implicit,t=e.XpG(2);e.R7$(2),e.JRh(i.id),e.R7$(2),e.HbH(e.VkB("badge event-badge ",t.getEventBadgeClass(i))),e.R7$(),e.JRh(t.getEventLabel(i)),e.R7$(3),e.JRh(i.resource_type),e.R7$(3),e.SpI("#",i.resource_id),e.R7$(4),e.JRh(i.old_preview||"-"),e.R7$(4),e.JRh(i.new_preview||"-"),e.R7$(2),e.Y8G("title",e.mNQ(i.changed_by)),e.R7$(),e.JRh(i.changed_by||"anonymous"),e.R7$(2),e.JRh(e.i5U(25,13,i.created_at,"short"))}}function f(a,s){if(1&a&&(e.j41(0,"div",24)(1,"table",25)(2,"thead")(3,"tr")(4,"th",26),e.EFF(5,"ID"),e.k0s(),e.j41(6,"th",27),e.EFF(7,"Evento"),e.k0s(),e.j41(8,"th",27),e.EFF(9,"Recurso"),e.k0s(),e.j41(10,"th"),e.EFF(11,"Old"),e.k0s(),e.j41(12,"th"),e.EFF(13,"New"),e.k0s(),e.j41(14,"th",28),e.EFF(15,"Usuario"),e.k0s(),e.j41(16,"th",27),e.EFF(17,"Fecha"),e.k0s()()(),e.j41(18,"tbody"),e.DNE(19,_,26,16,"tr",29),e.k0s()()()),2&a){const i=e.XpG();e.R7$(19),e.Y8G("ngForOf",i.filteredRecords)}}function m(a,s){1&a&&(e.j41(0,"span"),e.EFF(1,"Deshacer"),e.k0s())}function h(a,s){1&a&&(e.j41(0,"span"),e.EFF(1,"Deshaciendo..."),e.k0s())}function b(a,s){if(1&a){const i=e.RV6();e.j41(0,"tr")(1,"td",30),e.EFF(2),e.k0s(),e.j41(3,"td")(4,"span"),e.EFF(5),e.k0s()(),e.j41(6,"td")(7,"small",31),e.EFF(8),e.k0s(),e.j41(9,"div",32)(10,"strong"),e.EFF(11),e.k0s()()(),e.j41(12,"td")(13,"div",33)(14,"pre",34),e.EFF(15),e.k0s()()(),e.j41(16,"td")(17,"div",33)(18,"pre",34),e.EFF(19),e.k0s()()(),e.j41(20,"td")(21,"div",35),e.EFF(22),e.k0s()(),e.j41(23,"td"),e.EFF(24),e.nI1(25,"date"),e.k0s(),e.j41(26,"td")(27,"div",37)(28,"button",38),e.bIt("click",function(){const n=u.eBV(i).$implicit,r=e.XpG(2);return u.Njj(r.undo(n.id))}),e.DNE(29,m,2,0,"span",39)(30,h,2,0,"span",39),e.k0s()()()()}if(2&a){const i=s.$implicit,t=e.XpG(2);e.R7$(2),e.JRh(i.id),e.R7$(2),e.HbH(e.VkB("badge event-badge ",t.getEventBadgeClass(i))),e.R7$(),e.JRh(t.getEventLabel(i)),e.R7$(3),e.JRh(i.resource_type),e.R7$(3),e.SpI("#",i.resource_id),e.R7$(4),e.JRh(i.old_preview||"-"),e.R7$(4),e.JRh(i.new_preview||"-"),e.R7$(2),e.Y8G("title",e.mNQ(i.changed_by)),e.R7$(),e.JRh(i.changed_by||"anonymous"),e.R7$(2),e.JRh(e.i5U(25,16,i.created_at,"short")),e.R7$(4),e.Y8G("disabled",t.undoing[i.id]),e.R7$(),e.Y8G("ngIf",!t.undoing[i.id]),e.R7$(),e.Y8G("ngIf",t.undoing[i.id])}}function C(a,s){if(1&a&&(e.j41(0,"div",24)(1,"table",25)(2,"thead")(3,"tr")(4,"th",26),e.EFF(5,"ID"),e.k0s(),e.j41(6,"th",27),e.EFF(7,"Evento"),e.k0s(),e.j41(8,"th",27),e.EFF(9,"Recurso"),e.k0s(),e.j41(10,"th"),e.EFF(11,"Old"),e.k0s(),e.j41(12,"th"),e.EFF(13,"New"),e.k0s(),e.j41(14,"th",28),e.EFF(15,"Usuario"),e.k0s(),e.j41(16,"th",27),e.EFF(17,"Fecha"),e.k0s(),e.j41(18,"th",36),e.EFF(19,"Acciones"),e.k0s()()(),e.j41(20,"tbody"),e.DNE(21,b,31,19,"tr",29),e.k0s()()()),2&a){const i=e.XpG();e.R7$(21),e.Y8G("ngForOf",i.filteredRecords)}}let v=(()=>{class a{http;records=[];activeTab="appointments";undoing={};quickSearch="";apiBase=window.__env&&window.__env.apiUrl?window.__env.apiUrl:"/api";filterEvent=null;filterResourceId=null;filterChangedBy=null;filterSince=null;filterUntil=null;filterLimit=200;constructor(i){this.http=i}ngOnInit(){this.load()}setTab(i){this.activeTab=i,this.load()}load(){const t=[];t.push("resource="+("users"===this.activeTab?"user":"appointment")),this.filterEvent&&t.push(`event=${encodeURIComponent(this.filterEvent)}`),this.filterResourceId&&t.push(`resource_id=${encodeURIComponent(this.filterResourceId)}`),this.filterChangedBy&&t.push(`user=${encodeURIComponent(this.filterChangedBy)}`),this.filterSince&&t.push(`since=${encodeURIComponent(this.filterSince)}`),this.filterUntil&&t.push(`until=${encodeURIComponent(this.filterUntil)}`),t.push(`limit=${encodeURIComponent(String(this.filterLimit||200))}`),t.push(`_=${Date.now()}`);const n=`${this.apiBase}/audit?${t.join("&")}`;this.http.get(n,{headers:{Accept:"application/json"}}).subscribe({next:r=>{r&&r.success&&(this.records=r.data||[])},error:r=>{console.error("Error loading audit",r)}})}applyFilters(){this.load()}clearFilters(){this.filterEvent=null,this.filterResourceId=null,this.filterChangedBy=null,this.filterSince=null,this.filterUntil=null,this.filterLimit=200,this.load()}get filteredRecords(){const i=(this.quickSearch||"").toString().toLowerCase().trim();if(!i)return this.records||[];const t=n=>(n??"").toString().toLowerCase().includes(i);return(this.records||[]).filter(n=>{try{return t(this.getEventLabel(n))||t(n.resource_type)||t(n.resource_id)||t(n.changed_by)||t(n.old_preview)||t(n.new_preview)||t(n.event_type)}catch{return!1}})}getEventLabel(i){const t=String(i.event_type||"").toLowerCase();if("user"===(i.resource_type||"").toLowerCase()||"users"===this.activeTab)return t.includes("create")||t.includes("user_create")?"Creaci\xf3n usuario":t.includes("update")||t.includes("edit")||t.includes("user_update")?"Edici\xf3n usuario":t.includes("delete")||t.includes("inactivate")?"Eliminaci\xf3n usuario":t;const n=t.replace(/^appointment_?/,"");return n.includes("create")?"Creaci\xf3n cita":n.includes("confirm")?"Confirmaci\xf3n cita":n.includes("cancel")?"Cancelaci\xf3n cita":n.includes("undo")?"Deshacer cita":n||t}getEventBadgeClass(i){const t=this.getEventLabel(i).toLowerCase();return t.includes("confirm")?"confirm":t.includes("cancel")?"cancel":t.includes("creaci\xf3n")||t.includes("creacion")||t.includes("create")?"create":t.includes("edici")||t.includes("edit")?"edit":"create"}undo(i){confirm("\xbfSeguro que quieres deshacer este cambio de cita?")&&(this.undoing[i]=!0,this.http.post(`${this.apiBase}/audit/${i}/undo`,{},{headers:{Accept:"application/json"}}).subscribe({next:t=>{this.undoing[i]=!1,this.load(),alert(t&&t.message?t.message:"Deshecho")},error:t=>{console.error("Undo failed",t);const n=t&&t.status?t.status:0;404===n||0===n?(console.warn("Retrying undo directly against configured backend",this.apiBase),this.http.post(`${this.apiBase}/audit/${i}/undo`,{},{headers:{Accept:"application/json"}}).subscribe({next:r=>{this.undoing[i]=!1,this.load(),alert(r&&r.message?r.message:"Deshecho (directo)")},error:r=>{this.undoing[i]=!1,console.error("Direct undo failed",r),alert("Error al deshacer (directo): "+(r?.error?.message||r.message||r))}})):(this.undoing[i]=!1,alert("Error al deshacer: "+(t?.error?.message||t.message||t)))}}))}static \u0275fac=function(t){return new(t||a)(e.rXU(g.Qq))};static \u0275cmp=e.VBU({type:a,selectors:[["app-audit-history"]],decls:49,vars:17,consts:[[1,"audit-history","card","p-3"],[1,"toolbar","d-flex","align-items-center","justify-content-between","p-2","mb-2","flex-wrap","gap-2"],[1,"m-0"],[1,"d-flex","align-items-center","gap-2","flex-wrap"],[1,"input-group"],["placeholder","B\xfasqueda r\xe1pida (evento, recurso, usuario, contenido)",1,"form-control",3,"ngModelChange","ngModel"],[1,"btn","btn-outline-success",3,"click"],["role","tablist","aria-label","Tipo de historial",1,"tabs","mb-3"],["type","button",1,"tab-btn",3,"click","aria-pressed"],[1,"filters","mb-3","toolbar","p-2"],[1,"filter-row"],[1,"filter-item"],[1,"filter-label"],["placeholder","p.ej. appointment_cancel",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["placeholder","ID",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["placeholder","email",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],["type","date",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"filter-item",2,"min-width","90px"],["type","number","min","1","max","1000",1,"form-control","form-control-sm",3,"ngModelChange","ngModel"],[1,"filter-actions"],[1,"btn","btn-sm","btn-primary",3,"click"],[1,"btn","btn-sm","btn-secondary",3,"click"],["title","Actualizar la tabla con los \xfaltimos eventos",1,"btn","btn-sm","btn-success",3,"click"],["class","audit-table-wrap",4,"ngIf"],[1,"audit-table-wrap"],[1,"table","table-sm","audit-table","table-modern","table-card"],[2,"width","56px"],[2,"width","140px"],[2,"width","120px"],[4,"ngFor","ngForOf"],[1,"cell-id"],[1,"text-muted"],[1,"text-nowrap"],[1,"cell-preview"],[1,"m-0","small"],[1,"text-truncate",3,"title"],[2,"width","110px"],[1,"d-flex"],[1,"btn","btn-sm","btn-outline-primary","me-1",3,"click","disabled"],[4,"ngIf"]],template:function(t,n){1&t&&(e.j41(0,"div",0)(1,"div",1)(2,"h5",2),e.EFF(3,"Historial de cambios"),e.k0s(),e.j41(4,"div",3)(5,"div",4)(6,"input",5),e.mxI("ngModelChange",function(o){return e.DH7(n.quickSearch,o)||(n.quickSearch=o),o}),e.k0s()(),e.j41(7,"button",6),e.bIt("click",function(){return n.load()}),e.EFF(8,"Actualizar"),e.k0s()()(),e.j41(9,"div",7)(10,"button",8),e.bIt("click",function(){return n.setTab("users")}),e.EFF(11,"Usuarios"),e.k0s(),e.j41(12,"button",8),e.bIt("click",function(){return n.setTab("appointments")}),e.EFF(13,"Citas"),e.k0s()(),e.j41(14,"div",9)(15,"div",10)(16,"div",11)(17,"label",12),e.EFF(18,"Evento"),e.k0s(),e.j41(19,"input",13),e.mxI("ngModelChange",function(o){return e.DH7(n.filterEvent,o)||(n.filterEvent=o),o}),e.k0s()(),e.j41(20,"div",11)(21,"label",12),e.EFF(22,"Resource ID"),e.k0s(),e.j41(23,"input",14),e.mxI("ngModelChange",function(o){return e.DH7(n.filterResourceId,o)||(n.filterResourceId=o),o}),e.k0s()(),e.j41(24,"div",11)(25,"label",12),e.EFF(26,"Cambiado por"),e.k0s(),e.j41(27,"input",15),e.mxI("ngModelChange",function(o){return e.DH7(n.filterChangedBy,o)||(n.filterChangedBy=o),o}),e.k0s()(),e.j41(28,"div",11)(29,"label",12),e.EFF(30,"Desde"),e.k0s(),e.j41(31,"input",16),e.mxI("ngModelChange",function(o){return e.DH7(n.filterSince,o)||(n.filterSince=o),o}),e.k0s()(),e.j41(32,"div",11)(33,"label",12),e.EFF(34,"Hasta"),e.k0s(),e.j41(35,"input",16),e.mxI("ngModelChange",function(o){return e.DH7(n.filterUntil,o)||(n.filterUntil=o),o}),e.k0s()(),e.j41(36,"div",17)(37,"label",12),e.EFF(38,"L\xedmite"),e.k0s(),e.j41(39,"input",18),e.mxI("ngModelChange",function(o){return e.DH7(n.filterLimit,o)||(n.filterLimit=o),o}),e.k0s()(),e.j41(40,"div",19)(41,"button",20),e.bIt("click",function(){return n.applyFilters()}),e.EFF(42,"Aplicar"),e.k0s(),e.j41(43,"button",21),e.bIt("click",function(){return n.clearFilters()}),e.EFF(44,"Limpiar"),e.k0s(),e.j41(45,"button",22),e.bIt("click",function(){return n.load()}),e.EFF(46,"Actualizar"),e.k0s()()()(),e.DNE(47,f,20,1,"div",23)(48,C,22,1,"div",23),e.k0s()),2&t&&(e.R7$(6),e.R50("ngModel",n.quickSearch),e.R7$(4),e.AVh("active","users"===n.activeTab),e.jOp("aria-pressed",e.mNQ("users"===n.activeTab)),e.R7$(2),e.AVh("active","appointments"===n.activeTab),e.jOp("aria-pressed",e.mNQ("appointments"===n.activeTab)),e.R7$(7),e.R50("ngModel",n.filterEvent),e.R7$(4),e.R50("ngModel",n.filterResourceId),e.R7$(4),e.R50("ngModel",n.filterChangedBy),e.R7$(4),e.R50("ngModel",n.filterSince),e.R7$(4),e.R50("ngModel",n.filterUntil),e.R7$(4),e.R50("ngModel",n.filterLimit),e.R7$(8),e.Y8G("ngIf","users"===n.activeTab),e.R7$(),e.Y8G("ngIf","appointments"===n.activeTab))},dependencies:[c.MD,c.Sq,c.bT,l.YN,l.me,l.Q0,l.BC,l.VZ,l.zX,l.vS,c.vh],styles:[".audit-history[_ngcontent-%COMP%]{background:var(--surface-1);border:1px solid var(--border-color);border-radius:var(--radius-md);box-shadow:var(--shadow-1)}.audit-table[_ngcontent-%COMP%]{table-layout:fixed;width:100%}.audit-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:top;padding:.5rem}.audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell-preview[_ngcontent-%COMP%]{max-height:6.5em;overflow:auto;background:var(--surface-2);border-radius:6px;padding:.35rem;border:1px solid var(--border-color)}.audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell-preview[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{white-space:pre-wrap;word-break:break-word;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Roboto Mono,Courier New,monospace;font-size:.8rem;color:var(--text-dark)}[data-theme=dark][_ngcontent-%COMP%]   .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell-preview[_ngcontent-%COMP%]{background:#ffffff0f;border-color:#ffffff1f}[data-theme=dark][_ngcontent-%COMP%]   .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .cell-preview[_ngcontent-%COMP%]   pre[_ngcontent-%COMP%]{color:#e5e7eb}.text-truncate[_ngcontent-%COMP%]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}@media (max-width: 768px){.audit-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{display:none}.audit-table[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%], .audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{display:block;width:100%}.audit-table[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{margin-bottom:.75rem;border-bottom:1px solid #e9ecef}.audit-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{text-align:left;padding-left:0}.cell-id[_ngcontent-%COMP%]{font-weight:600}}.filter-label[_ngcontent-%COMP%]{display:block;font-size:.78rem;color:var(--text-light);margin-bottom:.35rem}.audit-history[_ngcontent-%COMP%]{border:1px solid var(--border-color)}.event-badge[_ngcontent-%COMP%]{padding:.35rem .6rem;border-radius:999px;font-weight:600;font-size:.82rem}.event-badge.confirm[_ngcontent-%COMP%]{background:linear-gradient(90deg,var(--light-green),var(--primary-green));color:#fff}.event-badge.cancel[_ngcontent-%COMP%]{background:linear-gradient(90deg,#ffb3b3,var(--danger));color:#fff}.event-badge.create[_ngcontent-%COMP%]{background:linear-gradient(90deg,var(--lighter-green),var(--light-green));color:#fff}.event-badge.edit[_ngcontent-%COMP%]{background:linear-gradient(90deg,#f0f0f0,#dfe6e0);color:var(--text-dark)}.tabs[_ngcontent-%COMP%]{display:flex;gap:.5rem}.tab-btn[_ngcontent-%COMP%]{background:transparent;border:1px solid transparent;padding:.5rem .9rem;border-radius:8px;cursor:pointer;font-weight:600}.tab-btn.active[_ngcontent-%COMP%]{background:linear-gradient(90deg,var(--lighter-green),var(--light-green));color:#fff;border-color:#0000000d}.filter-row[_ngcontent-%COMP%]{display:flex;gap:.75rem;align-items:flex-end;flex-wrap:wrap}.filter-item[_ngcontent-%COMP%]{min-width:160px;display:flex;flex-direction:column}.filter-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}@media (max-width: 920px){.filter-item[_ngcontent-%COMP%]{min-width:140px}}@media (max-width: 640px){.filter-row[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.filter-actions[_ngcontent-%COMP%]{justify-content:flex-start}}"]})}return a})()}}]);