"use strict";(self.webpackChunkdermatologia_app=self.webpackChunkdermatologia_app||[]).push([[1],{6001:(L,u,l)=>{l.r(u),l.d(u,{DoctorPrescriptionComponent:()=>T});var k=l(4523),p=l(2200),s=l(9417),C=l(3985),x=l(7239),y=l.n(x),t=l(3664),m=l(2615),D=l(4796),j=l(8397),g=l(7673),f=l(9437),h=l(9330);let I=(()=>{class r{http;apiUrl=window.__env?.apiUrl||"/api";storageKey="med_catalog_local";constructor(e){this.http=e}search(e,n=10){const o=`${this.apiUrl}/medicamentos?q=${encodeURIComponent(e)}&limit=${n}`;return this.http.get(o).pipe((0,f.W)(()=>{const c=(this.readLocal()||[]).filter(a=>a.toLowerCase().includes(e.toLowerCase())).slice(0,n);return(0,g.of)({success:!0,data:c.map(a=>({nombre:a}))})}))}add(e){return this.http.post(`${this.apiUrl}/medicamentos`,{nombre:e}).pipe((0,f.W)(()=>{const o=new Set(this.readLocal());return o.add(e),this.writeLocal(Array.from(o.values())),(0,g.of)({success:!0})}))}readLocal(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch{return[]}}writeLocal(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch{}}static \u0275fac=function(n){return new(n||r)(m.KVO(h.Qq))};static \u0275prov=m.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var E=l(3711);const G=()=>[];function N(r,d){1&r&&t.nrm(0,"span",38)}function O(r,d){if(1&r&&(t.j41(0,"option",39),t.EFF(1),t.k0s()),2&r){const e=d.$implicit;t.Y8G("value",e.DPI),t.R7$(),t.Lme(" ",(e.Nombres||e.nombres||"")+" "+(e.Apellidos||e.apellidos||"")," \u2014 DPI: ",e.DPI," ")}}function $(r,d){if(1&r){const e=t.RV6();t.j41(0,"li",53),t.bIt("click",function(){const o=m.eBV(e).$implicit,i=t.XpG(2).index,c=t.XpG();return m.Njj(c.applySuggestion(i,o))}),t.EFF(1),t.k0s()}if(2&r){const e=d.$implicit;t.R7$(),t.JRh(e)}}function R(r,d){if(1&r&&(t.j41(0,"ul",51),t.DNE(1,$,2,1,"li",52),t.k0s()),2&r){const e=t.XpG().index,n=t.XpG();t.R7$(),t.Y8G("ngForOf",n.suggestions[e])}}function S(r,d){if(1&r){const e=t.RV6();t.j41(0,"div",40)(1,"div",41)(2,"label",10),t.EFF(3,"Cantidad"),t.k0s(),t.nrm(4,"input",42),t.k0s(),t.j41(5,"div",43)(6,"label",10),t.EFF(7,"Medicamento"),t.k0s(),t.j41(8,"input",44),t.bIt("input",function(){const o=m.eBV(e).index,i=t.XpG();return m.Njj(i.onNameInput(o))}),t.k0s(),t.DNE(9,R,2,1,"ul",45),t.k0s(),t.j41(10,"div",46)(11,"label",10),t.EFF(12,"Dosis"),t.k0s(),t.nrm(13,"input",47),t.k0s(),t.j41(14,"div",48)(15,"button",49),t.bIt("click",function(){const o=m.eBV(e).index,i=t.XpG();return m.Njj(i.removeItem(o))}),t.nrm(16,"i",50),t.k0s()()()}if(2&r){const e=d.index,n=t.XpG();t.Y8G("formGroupName",e),t.R7$(9),t.Y8G("ngIf",(n.suggestions[e]||t.lJ4(3,G)).length>0),t.R7$(6),t.Y8G("disabled",n.items.length<=1)}}function M(r,d){if(1&r&&(t.j41(0,"div",54)(1,"div")(2,"strong"),t.EFF(3),t.k0s()(),t.j41(4,"div",29),t.EFF(5),t.k0s(),t.j41(6,"div",29),t.EFF(7),t.k0s(),t.nrm(8,"div",55),t.k0s()),2&r){let e,n,o;const i=d.$implicit;t.Y8G("formGroupName",d.index),t.R7$(3),t.JRh((null==(e=i.get("nombre"))?null:e.value)||"\u2014"),t.R7$(2),t.SpI("",(null==(n=i.get("cantidad"))?null:n.value)||"\u2014"," unidades"),t.R7$(2),t.JRh((null==(o=i.get("dosis"))?null:o.value)||"\u2014")}}function w(r,d){if(1&r&&(t.j41(0,"div",22)(1,"div",56),t.EFF(2,"Otras indicaciones"),t.k0s(),t.j41(3,"div",29),t.EFF(4),t.k0s()()),2&r){let e;const n=t.XpG();t.R7$(4),t.JRh(null==(e=n.form.get("observaciones"))?null:e.value)}}let T=(()=>{class r{fb;auth;toast;meds;patientsSvc;http;form;today=new Date;doctorName="";doctorEmail="";doctorColegiado="";maxItems=15;isGenerating=!1;logoPath="assets/favicon.svg";clinicPhone="4265-8975";clinicAddress="4ta calle 13-47 zona 3, segundo nivel";suggestions={};patients=[];selectedPatient=null;constructor(e,n,o,i,c,a){this.fb=e,this.auth=n,this.toast=o,this.meds=i,this.patientsSvc=c,this.http=a}ngOnInit(){const e=this.auth.currentUserValue;(!e||"doctor"!==String(e.tipo).toLowerCase())&&this.toast.show("Solo los doctores pueden generar recetas","error"),this.doctorName=`${e?.nombres||""} ${e?.apellidos||""}`.trim(),this.doctorEmail=e?.correo||"",this.doctorColegiado=e?.colegiado||"",this.form=this.fb.group({fecha:[this.formatDate(this.today),[s.k0.required]],doctor:[{value:this.doctorName,disabled:!0}],pacienteDPI:["",[s.k0.required]],items:this.fb.array([this.createItem()]),observaciones:[""]}),this.patientsSvc.list(!1).subscribe(n=>{this.patients=n||[]})}get items(){return this.form.get("items")}createItem(){return this.fb.group({cantidad:[null,[s.k0.min(.01),s.k0.required]],nombre:["",[s.k0.required,s.k0.maxLength(255)]],dosis:["",[s.k0.required,s.k0.maxLength(255)]]})}addItem(){this.items.length>=this.maxItems||this.items.push(this.createItem())}removeItem(e){this.items.length<=1||this.items.removeAt(e)}onNameInput(e){const o=(this.items.at(e).get("nombre")?.value||"").toString().trim();o?this.meds.search(o).subscribe({next:i=>{this.suggestions[e]=(i?.data||i||[]).map(c=>c.nombre||c.Nombre||c)},error:i=>{this.suggestions[e]=[]}}):this.suggestions[e]=[]}applySuggestion(e,n){this.items.at(e).get("nombre")?.setValue(n),this.suggestions[e]=[]}canGenerate(){return this.form.valid&&this.items.length>0&&!this.isGenerating}formatDate(e){const n=o=>o.toString().padStart(2,"0");return`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())}`}generatePdf(){var e=this;return(0,k.A)(function*(){if(e.canGenerate()){e.isGenerating=!0;try{const n=new Set;e.items.value.forEach(o=>{const i=(o.nombre||"").toString().trim();i&&n.add(i)});for(const o of n)try{yield e.meds.add(o).toPromise()}catch{}}catch{}try{const n=e.buildPayload();try{yield e.http.post((window.__env?.apiUrl||"/api")+"/recetas",n).toPromise()}catch(U){console.warn("[RECETAS] error al guardar",U),e.toast.show("No se pudo guardar la receta en el servidor","error")}const o=document.getElementById("rx-sheet");if(!o)return e.toast.show("No se encontr\xf3 la plantilla de la receta","error"),void(e.isGenerating=!1);const i=yield y()(o,{scale:2,useCORS:!0,backgroundColor:"#ffffff"}),c=i.toDataURL("image/png"),a=new C.Ay("p","pt","letter"),v=a.internal.pageSize.getWidth(),_=a.internal.pageSize.getHeight(),b=Math.min(v/i.width,_/i.height),F=i.width*b,P=i.height*b;a.addImage(c,"PNG",(v-F)/2,(_-P)/2,F,P,void 0,"FAST"),a.save(`receta_${e.formatDate(new Date)}.pdf`),e.toast.show("PDF generado correctamente")}catch(n){console.error("[PDF] error",n),e.toast.show("No se pudo generar el PDF","error")}finally{e.isGenerating=!1}}else e.toast.show("Completa los campos requeridos","error")})()}buildPayload(){const e=this.items.value.map(o=>({cantidad:Number(o.cantidad),nombre:(o.nombre||"").trim(),dosis:(o.dosis||"").trim()})),n=this.form.get("pacienteDPI")?.value;return{fecha:this.form.get("fecha")?.value,doctor:{nombre:this.doctorName,correo:this.doctorEmail,colegiado:this.doctorColegiado},paciente_dpi:n,observaciones:this.form.get("observaciones")?.value||"",items:e}}getSelectedPatient(){try{const e=this.form.get("pacienteDPI")?.value;return this.patients.find(o=>String(o.DPI)===String(e))||null}catch{return null}}static \u0275fac=function(n){return new(n||r)(t.rXU(s.ok),t.rXU(D.u),t.rXU(j.f),t.rXU(I),t.rXU(E.X),t.rXU(h.Qq))};static \u0275cmp=t.VBU({type:r,selectors:[["app-doctor-prescription"]],decls:73,vars:18,consts:[[1,"container-xxl","py-3"],[1,"toolbar","d-flex","align-items-center","justify-content-between","p-2","mb-3","flex-wrap","gap-2"],[1,"m-0"],[1,"d-flex","align-items-center","gap-2"],[1,"btn","btn-primary",3,"click","disabled"],["class","spinner-border spinner-border-sm me-1",4,"ngIf"],[1,"card",3,"formGroup"],[1,"card-body"],[1,"row","g-3","mb-3"],[1,"col-sm-4"],[1,"form-label"],["type","date","formControlName","fecha",1,"form-control"],[1,"col-sm-8"],["type","text","disabled","",1,"form-control",3,"value"],[1,"col-12","col-md-8"],["formControlName","pacienteDPI",1,"form-control"],["value","","disabled",""],[3,"value",4,"ngFor","ngForOf"],[1,"d-flex","align-items-center","justify-content-between","mb-2"],["type","button",1,"btn","btn-outline-primary","btn-sm",3,"click","disabled"],["formArrayName","items",1,"rx-items"],["class","row g-2 align-items-end mb-2",3,"formGroupName",4,"ngFor","ngForOf"],[1,"mt-3"],["rows","3","formControlName","observaciones","placeholder","Indicaciones adicionales",1,"form-control"],["id","rx-sheet",1,"rx-sheet","mt-3"],[1,"rx-header","d-flex","align-items-start","justify-content-between"],[1,"d-flex","align-items-center","gap-3"],["alt","logo",1,"rx-logo",3,"src"],[1,"fw-semibold"],[1,"small"],[1,"text-end","small"],[1,"rx-body","mt-3"],["class","rx-item",3,"formGroupName",4,"ngFor","ngForOf"],["class","mt-3",4,"ngIf"],[1,"small","mt-2"],[1,"rx-footer"],[1,"signature"],[1,"small","text-center"],[1,"spinner-border","spinner-border-sm","me-1"],[3,"value"],[1,"row","g-2","align-items-end","mb-2",3,"formGroupName"],[1,"col-12","col-md-2"],["type","number","step","0.01","min","0.01","formControlName","cantidad",1,"form-control"],[1,"col-12","col-md-4","position-relative"],["type","text","formControlName","nombre","autocomplete","off",1,"form-control",3,"input"],["class","list-group suggestions",4,"ngIf"],[1,"col-12","col-md-5"],["type","text","formControlName","dosis",1,"form-control"],[1,"col-12","col-md-1","text-end"],["type","button",1,"btn","btn-outline-danger",3,"click","disabled"],[1,"fas","fa-trash"],[1,"list-group","suggestions"],["class","list-group-item list-group-item-action",3,"click",4,"ngFor","ngForOf"],[1,"list-group-item","list-group-item-action",3,"click"],[1,"rx-item",3,"formGroupName"],[1,"divider"],[1,"fw-semibold","mb-1"]],template:function(n,o){if(1&n&&(t.j41(0,"div",0)(1,"div",1)(2,"h5",2),t.EFF(3,"Generaci\xf3n de receta"),t.k0s(),t.j41(4,"div",3)(5,"button",4),t.bIt("click",function(){return o.generatePdf()}),t.DNE(6,N,1,0,"span",5),t.EFF(7," Generar PDF "),t.k0s()()(),t.j41(8,"form",6)(9,"div",7)(10,"div",8)(11,"div",9)(12,"label",10),t.EFF(13,"Fecha"),t.k0s(),t.nrm(14,"input",11),t.k0s(),t.j41(15,"div",12)(16,"label",10),t.EFF(17,"Doctor"),t.k0s(),t.nrm(18,"input",13),t.k0s()(),t.j41(19,"div",8)(20,"div",14)(21,"label",10),t.EFF(22,"Paciente"),t.k0s(),t.j41(23,"select",15)(24,"option",16),t.EFF(25,"Seleccione un paciente"),t.k0s(),t.DNE(26,O,2,3,"option",17),t.k0s()()(),t.j41(27,"div",18)(28,"h6",2),t.EFF(29,"Medicamentos"),t.k0s(),t.j41(30,"button",19),t.bIt("click",function(){return o.addItem()}),t.EFF(31,"A\xf1adir \xedtem"),t.k0s()(),t.j41(32,"div",20),t.DNE(33,S,17,4,"div",21),t.k0s(),t.j41(34,"div",22)(35,"label",10),t.EFF(36,"Observaciones adicionales (opcional)"),t.k0s(),t.nrm(37,"textarea",23),t.k0s()()(),t.j41(38,"div",24)(39,"div",25)(40,"div",26),t.nrm(41,"img",27),t.j41(42,"div")(43,"div",28),t.EFF(44,"Centro Dermatol\xf3gico"),t.k0s(),t.j41(45,"div",29),t.EFF(46),t.k0s(),t.j41(47,"div",29),t.EFF(48),t.k0s(),t.j41(49,"div",29),t.EFF(50),t.k0s()()(),t.j41(51,"div",30)(52,"div")(53,"strong"),t.EFF(54),t.k0s()(),t.j41(55,"div"),t.EFF(56),t.k0s()()(),t.nrm(57,"hr"),t.j41(58,"div",29)(59,"strong"),t.EFF(60,"Paciente"),t.k0s(),t.EFF(61," __________________________________________"),t.k0s(),t.j41(62,"div",31),t.DNE(63,M,9,4,"div",32)(64,w,5,1,"div",33),t.k0s(),t.j41(65,"div",34)(66,"strong"),t.EFF(67,"Paciente:"),t.k0s(),t.EFF(68),t.k0s(),t.j41(69,"div",35),t.nrm(70,"div",36),t.j41(71,"div",37),t.EFF(72),t.k0s()()()()),2&n){let i,c,a;t.R7$(5),t.Y8G("disabled",!o.canGenerate()),t.R7$(),t.Y8G("ngIf",o.isGenerating),t.R7$(2),t.Y8G("formGroup",o.form),t.R7$(10),t.Y8G("value",o.doctorName),t.R7$(8),t.Y8G("ngForOf",o.patients),t.R7$(4),t.Y8G("disabled",o.items.length>=o.maxItems),t.R7$(3),t.Y8G("ngForOf",o.items.controls),t.R7$(8),t.Y8G("src",o.logoPath,t.B4B),t.R7$(5),t.JRh(o.clinicAddress),t.R7$(2),t.SpI("Tel\xe9fono: ",o.clinicPhone),t.R7$(2),t.SpI("Correo: ",o.doctorEmail),t.R7$(4),t.SpI("Dr(a). ",o.doctorName),t.R7$(2),t.SpI("Fecha: ",null==(i=o.form.get("fecha"))?null:i.value),t.R7$(7),t.Y8G("ngForOf",o.items.controls),t.R7$(),t.Y8G("ngIf",null==(c=o.form.get("observaciones"))?null:c.value),t.R7$(4),t.Lme(" ",((null==(a=o.getSelectedPatient())?null:a.Nombres)||(null==(a=o.getSelectedPatient())?null:a.nombres)||"")+" "+((null==(a=o.getSelectedPatient())?null:a.Apellidos)||(null==(a=o.getSelectedPatient())?null:a.apellidos)||"")," \u2014 DPI: ",(null==(a=o.form.get("pacienteDPI"))?null:a.value)||"\u2014"),t.R7$(4),t.SpI("Firma Dr(a). ",o.doctorName)}},dependencies:[p.MD,p.Sq,p.bT,s.YN,s.qT,s.xH,s.y7,s.me,s.Q0,s.wz,s.BC,s.cb,s.VZ,s.X1,s.j4,s.JD,s.$R,s.v8],styles:['.rx-sheet[_ngcontent-%COMP%]{background:#fff;color:#222;border:1px solid var(--border-color, #e5e7eb);border-radius:8px;padding:24px;position:relative;overflow:hidden}.rx-header[_ngcontent-%COMP%]   .rx-logo[_ngcontent-%COMP%]{width:56px;height:56px}.rx-body[_ngcontent-%COMP%]   .divider[_ngcontent-%COMP%]{height:10px;border-bottom:1px dashed #d0d5dd;margin:4px 0 10px}.rx-watermark[_ngcontent-%COMP%]{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:96px;color:#0000000d;pointer-events:none;-webkit-user-select:none;user-select:none}.rx-footer[_ngcontent-%COMP%]{margin-top:60px}.rx-footer[_ngcontent-%COMP%]   .signature[_ngcontent-%COMP%]{height:48px;border-bottom:2px solid #111827;margin:0 64px 6px}.suggestions[_ngcontent-%COMP%]{position:absolute;z-index:10;width:100%;max-height:180px;overflow:auto}[data-theme="dark"][_nghost-%COMP%]   .rx-sheet[_ngcontent-%COMP%], [data-theme="dark"]   [_nghost-%COMP%]   .rx-sheet[_ngcontent-%COMP%]{background:#0f172a;color:#e2e8f0;border-color:#1f2937}[data-theme="dark"][_nghost-%COMP%]   .rx-body[_ngcontent-%COMP%]   .divider[_ngcontent-%COMP%], [data-theme="dark"]   [_nghost-%COMP%]   .rx-body[_ngcontent-%COMP%]   .divider[_ngcontent-%COMP%]{border-bottom-color:#334155}[data-theme="dark"][_nghost-%COMP%]   .rx-footer[_ngcontent-%COMP%]   .signature[_ngcontent-%COMP%], [data-theme="dark"]   [_nghost-%COMP%]   .rx-footer[_ngcontent-%COMP%]   .signature[_ngcontent-%COMP%]{border-bottom-color:#e2e8f0}']})}return r})()}}]);